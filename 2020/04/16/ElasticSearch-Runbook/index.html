<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="AIn6RYiH7oyvpWJuW_neCErD4pn7Iy9IcaCwwDr7wJg">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"davidlu1001.github.io","root":"/","scheme":"Pisces","version":"7.7.2","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="ElasticSearch can be a beast to manage. Knowing the most used endpoints during outages or simple maintenance by heart can be as challenging as it is time consuming. Because of this, this How-To articl">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch Runbook">
<meta property="og:url" content="http://davidlu1001.github.io/2020/04/16/ElasticSearch-Runbook/index.html">
<meta property="og:site_name" content="Davidlu&#39;s Blog">
<meta property="og:description" content="ElasticSearch can be a beast to manage. Knowing the most used endpoints during outages or simple maintenance by heart can be as challenging as it is time consuming. Because of this, this How-To articl">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-04-15T22:07:57.000Z">
<meta property="article:modified_time" content="2020-12-11T09:52:39.132Z">
<meta property="article:author" content="David Lu">
<meta property="article:tag" content="ElasticSearch">
<meta property="article:tag" content="SRE">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://davidlu1001.github.io/2020/04/16/ElasticSearch-Runbook/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>ElasticSearch Runbook | Davidlu's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-62146539-2"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-62146539-2');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Davidlu's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Davidlu's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">DevOps / SRE</h1>
      
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">26</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">17</span></a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>Sitemap</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="search-pop-overlay">
  <div class="popup search-popup">
      <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

  </div>
</div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="http://davidlu1001.github.io/2020/04/16/ElasticSearch-Runbook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="David Lu">
      <meta itemprop="description" content="Technology enthusiast">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Davidlu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          ElasticSearch Runbook
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-16 10:07:57" itemprop="dateCreated datePublished" datetime="2020-04-16T10:07:57+12:00">2020-04-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SRE/" itemprop="url" rel="index"><span itemprop="name">SRE</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ElasticSearch/" itemprop="url" rel="index"><span itemprop="name">ElasticSearch</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/04/16/ElasticSearch-Runbook/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/04/16/ElasticSearch-Runbook/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>ElasticSearch can be a beast to manage. Knowing the most used endpoints during outages or simple maintenance by heart can be as challenging as it is time consuming. Because of this, this How-To article will layout some handy commands. In theory you could run them from any given node (data, client or master), however I’d recommend running them from a master node.</p>
<p>ssh into any master node (pro-tip: master instances are the ones within the master autoscaling group)</p>
<p>e.g.</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ssh</span> <span class="selector-tag">elastic-master-</span>&lt;<span class="selector-tag">instance-id</span>&gt;.&lt;<span class="selector-tag">aws-region</span>&gt;<span class="selector-class">.x</span><span class="selector-class">.y</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure>

<h2 id="Handy-aliases"><a href="#Handy-aliases" class="headerlink" title="Handy aliases"></a>Handy <code>aliases</code></h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alias</span> tail-es=<span class="string">&#x27;tail -500f /var/log/elasticsearch/&lt;ES_NAME&gt;/&lt;ES_Name&gt;.log&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> cat-nodes=<span class="string">&#x27;curl -s -XGET http://localhost:9200/_cat/nodes?v&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> cat-shards=<span class="string">&#x27;curl -s -XGET http://localhost:9200/_cat/shards?h=index,shard,prirep,state,unassigned.reason&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> cat-allocation=<span class="string">&#x27;curl -s -XGET http://localhost:9200/_cat/allocation?v&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> cat-indices=<span class="string">&#x27;curl -s -XGET http://localhost:9200/_cat/indices?v&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> <span class="keyword">get</span>-templates=<span class="string">&#x27;curl -s -XGET http://localhost:9200/_template?pretty&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> cat-settings=<span class="string">&#x27;curl -s -XGET http://localhost:9200/_cluster/settings/?pretty&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> cat-settings-<span class="keyword">all</span>=<span class="string">&#x27;curl -s -XGET &#x27;</span>\<span class="string">&#x27;&#x27;</span>http://localhost:<span class="number">9200</span>/_cluster/settings?include_defaults=<span class="keyword">true</span>&amp;pretty<span class="string">&#x27;\&#x27;&#x27; | jq .&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> <span class="keyword">cluster</span>-status=<span class="string">&#x27;curl -s -XGET http://localhost:9200/_cluster/health?pretty&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> <span class="keyword">check</span>-status=<span class="string">&#x27;while true; do sleep 5; cluster-status | grep status; done&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> <span class="keyword">disable</span>-allocation=<span class="string">&#x27;curl -XPUT localhost:9200/_cluster/settings -d &#x27;</span>\<span class="string">&#x27;&#x27;</span>&#123;&quot;transient&quot; : \&#123;&quot;cluster.routing.allocation.enable&quot; : &quot;none&quot;&#125;&#125;<span class="string">&#x27;\&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> <span class="keyword">enable</span>-allocation=<span class="string">&#x27;curl -XPUT localhost:9200/_cluster/settings -d &#x27;</span>\<span class="string">&#x27;&#x27;</span>&#123;&quot;transient&quot; : \&#123;&quot;cluster.routing.allocation.enable&quot; : &quot;all&quot;&#125;&#125;<span class="string">&#x27;\&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> cat-shards-unassigned=<span class="string">&#x27;curl -s -XGET http://localhost:9200/_cat/shards | grep UNASSIGNED | awk &#x27;</span>\<span class="string">&#x27;&#x27;</span>&#123;print <span class="meta">$1</span>&#125;<span class="string">&#x27;\&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> del-shards-unassigned=<span class="string">&#x27;curl -s -XGET http://localhost:9200/_cat/shards | grep UNASSIGNED | awk &#x27;</span>\<span class="string">&#x27;&#x27;</span>&#123;print <span class="meta">$1</span>&#125;<span class="string">&#x27;\&#x27;&#x27; | xargs -i curl -s -XDELETE &quot;http://localhost:9200/&#123;&#125;&quot;&#x27;</span></span><br><span class="line"><span class="keyword">alias</span> cat-<span class="keyword">snapshot</span>=<span class="string">&#x27;curl -s -XGET localhost:9200/_snapshot/&lt;S3_BUCKET_FOR_SNAPSHOT_REPOSITORY&gt;/_all?pretty | jq .snapshots[-1]&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="Cheatsheet"><a href="#Cheatsheet" class="headerlink" title="Cheatsheet"></a>Cheatsheet</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NlbWF0ZXh0L2NoZWF0c2hlZXRzL2Jsb2IvbWFzdGVyL2VsYXN0aWNzZWFyY2gtZGV2b3BzLWNoZWF0c2hlZXQubWQ=" title="https://github.com/sematext/cheatsheets/blob/master/elasticsearch-devops-cheatsheet.md">https://github.com/sematext/cheatsheets/blob/master/elasticsearch-devops-cheatsheet.md<i class="fa fa-external-link"></i></span></p>
<h2 id="Node-types"><a href="#Node-types" class="headerlink" title="Node types"></a>Node types</h2><p>Elasticsearch nodes can take one ore more roles. Here we are using the following node types:</p>
<ul>
<li>Master</li>
</ul>
<p>The master node is responsible for lightweight cluster-wide actions such as creating or deleting an index, tracking which nodes are part of the cluster, and deciding which shards to allocate to which nodes. It is important for cluster health to have a stable master node. Any master-eligible node (all nodes by default) may be elected to become the master node by the master election process.</p>
<ul>
<li>Data </li>
</ul>
<p>Data nodes hold the shards that contain the documents you have indexed. Data nodes handle data related operations like CRUD, search, and aggregations. These operations are I/O-, memory-, and CPU-intensive. It is important to monitor these resources and to add more data nodes if they are overloaded. </p>
<p>Can be subdivided into warm and hot nodes if wanting to <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ibG9nL2ltcGxlbWVudGluZy1ob3Qtd2FybS1jb2xkLWluLWVsYXN0aWNzZWFyY2gtd2l0aC1pbmRleC1saWZlY3ljbGUtbWFuYWdlbWVudA==" title="https://www.elastic.co/blog/implementing-hot-warm-cold-in-elasticsearch-with-index-lifecycle-management">Implement a Hot-Warm-Cold Architecture for ES<i class="fa fa-external-link"></i></span></p>
<ul>
<li>Client</li>
</ul>
<p>Can only route requests, handle the search reduce phase, and distribute bulk indexing. Essentially, coordinating (aka client) only nodes behave as smart load balancers. </p>
<h2 id="Cluster-health"><a href="#Cluster-health" class="headerlink" title="Cluster health"></a>Cluster health</h2><p>To check the overall cluster health (green, yellow or red) and keep polling for status just type cluster-status.</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">elastic-master:~$ check-status</span><br><span class="line">  <span class="string">&quot;status&quot;</span><span class="keyword"> :</span> <span class="string">&quot;green&quot;</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span><span class="keyword"> :</span> <span class="string">&quot;green&quot;</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span><span class="keyword"> :</span> <span class="string">&quot;green&quot;</span>,</span><br></pre></td></tr></table></figure>

<h2 id="Tailing-logs"><a href="#Tailing-logs" class="headerlink" title="Tailing logs"></a>Tailing logs</h2><p>Elasticsearch logs live in <code>/var/log/elasticsearch/&lt;cluster-name&gt;/&lt;cluster-name&gt;.log</code>. See the alias <code>tail-es</code> above.</p>
<h2 id="Listing-allocations"><a href="#Listing-allocations" class="headerlink" title="Listing allocations"></a>Listing allocations</h2><p>To list the allocations per host, just type <code>cat-allocation</code>.<br>This will show things like:</p>
<ul>
<li>shards per host</li>
<li>used disk</li>
<li>available disk</li>
<li>indice size</li>
<li>total disk size</li>
<li>disk usage percent<ul>
<li>This is an important metric. as a rule of thumb, once disk usage reaches <code>85%</code> things starts to go wild. ES will not allocate new shards to nodes once they have more than 85% disk used.</li>
</ul>
</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">elastic</span>-master:~$ cat-allocation</span><br><span class="line"><span class="attribute">shards</span> disk.indices disk.used disk.avail disk.total disk.percent host          ip            node</span><br><span class="line">   <span class="attribute">927</span>      <span class="number">434</span>.<span class="number">5</span>gb   <span class="number">472</span>.<span class="number">8</span>gb    <span class="number">265</span>.<span class="number">2</span>gb    <span class="number">738</span>.<span class="number">1</span>gb           <span class="number">64</span> <span class="number">172.21.5.57</span>   <span class="number">172.21.5.57</span>   elastic-data-<span class="number">096596</span>c<span class="number">27</span>d<span class="number">5</span>ea<span class="number">41</span>b<span class="number">8</span>-production</span><br><span class="line">   <span class="attribute">928</span>      <span class="number">440</span>.<span class="number">8</span>gb   <span class="number">479</span>.<span class="number">1</span>gb    <span class="number">258</span>.<span class="number">9</span>gb    <span class="number">738</span>.<span class="number">1</span>gb           <span class="number">64</span> <span class="number">172.21.22.28</span>  <span class="number">172.21.22.28</span>  elastic-data-<span class="number">015</span>b<span class="number">67</span>ccc<span class="number">6632775</span>b-production</span><br><span class="line">   <span class="attribute">927</span>      <span class="number">496</span>.<span class="number">4</span>gb   <span class="number">534</span>.<span class="number">7</span>gb    <span class="number">203</span>.<span class="number">3</span>gb    <span class="number">738</span>.<span class="number">1</span>gb           <span class="number">72</span> <span class="number">172.21.21.209</span> <span class="number">172.21.21.209</span> elastic-data-<span class="number">02</span>b<span class="number">5</span>fb<span class="number">2</span>c<span class="number">632</span>eacc<span class="number">9</span>f-production</span><br><span class="line">   <span class="attribute">927</span>      <span class="number">463</span>.<span class="number">8</span>gb     <span class="number">502</span>gb      <span class="number">236</span>gb    <span class="number">738</span>.<span class="number">1</span>gb           <span class="number">68</span> <span class="number">172.21.5.138</span>  <span class="number">172.21.5.138</span>  elastic-data-<span class="number">07</span>aa<span class="number">318</span>c<span class="number">82</span>d<span class="number">04</span>e<span class="number">61</span>c-production</span><br><span class="line">   <span class="attribute">927</span>      <span class="number">436</span>.<span class="number">2</span>gb     <span class="number">475</span>gb      <span class="number">263</span>gb    <span class="number">738</span>.<span class="number">1</span>gb           <span class="number">64</span> <span class="number">172.21.39.147</span> <span class="number">172.21.39.147</span> elastic-data-<span class="number">0</span>a<span class="number">7381067</span>cc<span class="number">43</span>e<span class="number">698</span>-production</span><br><span class="line">   <span class="attribute">928</span>      <span class="number">457</span>.<span class="number">5</span>gb   <span class="number">495</span>.<span class="number">8</span>gb    <span class="number">242</span>.<span class="number">2</span>gb    <span class="number">738</span>.<span class="number">1</span>gb           <span class="number">67</span> <span class="number">172.21.5.32</span>   <span class="number">172.21.5.32</span>   elastic-data-<span class="number">05</span>a<span class="number">9</span>cd<span class="number">4</span>cea<span class="number">5328486</span>-production</span><br><span class="line">   <span class="attribute">927</span>      <span class="number">419</span>.<span class="number">1</span>gb   <span class="number">457</span>.<span class="number">3</span>gb    <span class="number">280</span>.<span class="number">7</span>gb    <span class="number">738</span>.<span class="number">1</span>gb           <span class="number">61</span> <span class="number">172.21.21.160</span> <span class="number">172.21.21.160</span> elastic-data-<span class="number">0</span>abf<span class="number">96</span>b<span class="number">0106</span>bcba<span class="number">98</span>-production</span><br><span class="line">   <span class="attribute">928</span>      <span class="number">447</span>.<span class="number">2</span>gb     <span class="number">485</span>gb      <span class="number">253</span>gb    <span class="number">738</span>.<span class="number">1</span>gb           <span class="number">65</span> <span class="number">172.21.38.167</span> <span class="number">172.21.38.167</span> elastic-data-<span class="number">0</span>b<span class="number">00</span>da<span class="number">1</span>daa<span class="number">6</span>c<span class="number">3</span>e<span class="number">055</span>-production</span><br><span class="line">   <span class="attribute">927</span>      <span class="number">472</span>.<span class="number">8</span>gb   <span class="number">510</span>.<span class="number">6</span>gb    <span class="number">227</span>.<span class="number">4</span>gb    <span class="number">738</span>.<span class="number">1</span>gb           <span class="number">69</span> <span class="number">172.21.39.249</span> <span class="number">172.21.39.249</span> elastic-data-<span class="number">09512</span>dff<span class="number">9</span>c<span class="number">057</span>e<span class="number">62</span>b-production</span><br></pre></td></tr></table></figure>

<h2 id="Deleting-corrupted-lost-shards"><a href="#Deleting-corrupted-lost-shards" class="headerlink" title="Deleting corrupted / lost shards"></a>Deleting corrupted / lost shards</h2><p>Sometimes shards can get corrupted or entirely lost. This will put the cluster in a <code>RED/YELLOW</code> state. If no other node have the unassigned shard and index, then the only option will be to delete them. To do so, run the alias <code>del-shards-unassigned</code> mentioned above or the command below:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s -XGET http:<span class="regexp">//</span>localhost:<span class="number">9200</span><span class="regexp">/_cat/</span>shards | grep UNASSIGNED | awk &#123;<span class="string">&#x27;print $1&#x27;</span>&#125; | xargs -i curl -s -XDELETE <span class="string">&quot;http://localhost:9200/&#123;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Listing-nodes"><a href="#Listing-nodes" class="headerlink" title="Listing nodes"></a>Listing nodes</h2><p>To list the nodes participating in a cluster, just type <code>cat-nodes</code>. The node with a star (<code>*</code>) is the actual master within that cluster.</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">elastic</span>-master:~$ cat-nodes</span><br><span class="line"><span class="attribute">host</span>          ip            heap.percent ram.percent load node.role master name</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">38</span>.<span class="number">167</span> <span class="number">172.21.38.167</span>           <span class="number">67</span>          <span class="number">99</span> <span class="number">8</span>.<span class="number">84</span> d         -      elastic-data-<span class="number">0</span>b<span class="number">00</span>da<span class="number">1</span>daa<span class="number">6</span>c<span class="number">3</span>e<span class="number">055</span>-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">5</span>.<span class="number">57</span>   <span class="number">172.21.5.57</span>             <span class="number">22</span>          <span class="number">99</span> <span class="number">4</span>.<span class="number">27</span> d         -      elastic-data-<span class="number">096596</span>c<span class="number">27</span>d<span class="number">5</span>ea<span class="number">41</span>b<span class="number">8</span>-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">39</span>.<span class="number">60</span>  <span class="number">172.21.39.60</span>            <span class="number">48</span>          <span class="number">91</span> <span class="number">0</span>.<span class="number">00</span> -         m      elastic-master-<span class="number">033</span>de<span class="number">9</span>aa<span class="number">1</span>c<span class="number">6</span>f<span class="number">03</span>b<span class="number">8</span>a-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">22</span>.<span class="number">28</span>  <span class="number">172.21.22.28</span>            <span class="number">74</span>          <span class="number">99</span> <span class="number">6</span>.<span class="number">41</span> d         -      elastic-data-<span class="number">015</span>b<span class="number">67</span>ccc<span class="number">6632775</span>b-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">39</span>.<span class="number">147</span> <span class="number">172.21.39.147</span>           <span class="number">21</span>          <span class="number">99</span> <span class="number">5</span>.<span class="number">07</span> d         -      elastic-data-<span class="number">0</span>a<span class="number">7381067</span>cc<span class="number">43</span>e<span class="number">698</span>-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">36</span>.<span class="number">186</span> <span class="number">172.21.36.186</span>           <span class="number">25</span>          <span class="number">98</span> <span class="number">0</span>.<span class="number">06</span> -         -      elastic-client-<span class="number">0</span>bdfaa<span class="number">8</span>f<span class="number">29</span>b<span class="number">51</span>ee<span class="number">5</span>c-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">6</span>.<span class="number">250</span>  <span class="number">172.21.6.250</span>            <span class="number">27</span>          <span class="number">87</span> <span class="number">0</span>.<span class="number">02</span> -         -      elastic-client-<span class="number">0579</span>bf<span class="number">60</span>b<span class="number">8746</span>b<span class="number">365</span>-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">20</span>.<span class="number">96</span>  <span class="number">172.21.20.96</span>             <span class="number">9</span>          <span class="number">84</span> <span class="number">0</span>.<span class="number">01</span> -         -      elastic-client-<span class="number">0</span>a<span class="number">25</span>e<span class="number">84</span>d<span class="number">941</span>f<span class="number">3446</span>f-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">5</span>.<span class="number">138</span>  <span class="number">172.21.5.138</span>            <span class="number">62</span>          <span class="number">99</span> <span class="number">6</span>.<span class="number">83</span> d         -      elastic-data-<span class="number">07</span>aa<span class="number">318</span>c<span class="number">82</span>d<span class="number">04</span>e<span class="number">61</span>c-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">7</span>.<span class="number">188</span>  <span class="number">172.21.7.188</span>            <span class="number">20</span>          <span class="number">93</span> <span class="number">0</span>.<span class="number">00</span> -         *      elastic-master-<span class="number">049</span>a<span class="number">20</span>b<span class="number">4645</span>a<span class="number">557</span>eb-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">21</span>.<span class="number">160</span> <span class="number">172.21.21.160</span>           <span class="number">17</span>          <span class="number">99</span> <span class="number">7</span>.<span class="number">49</span> d         -      elastic-data-<span class="number">0</span>abf<span class="number">96</span>b<span class="number">0106</span>bcba<span class="number">98</span>-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">5</span>.<span class="number">32</span>   <span class="number">172.21.5.32</span>             <span class="number">66</span>          <span class="number">99</span> <span class="number">6</span>.<span class="number">33</span> d         -      elastic-data-<span class="number">05</span>a<span class="number">9</span>cd<span class="number">4</span>cea<span class="number">5328486</span>-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">22</span>.<span class="number">253</span> <span class="number">172.21.22.253</span>           <span class="number">38</span>          <span class="number">85</span> <span class="number">0</span>.<span class="number">00</span> -         m      elastic-master-<span class="number">0644394056</span>fa<span class="number">488</span>a<span class="number">8</span>-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">21</span>.<span class="number">209</span> <span class="number">172.21.21.209</span>           <span class="number">19</span>          <span class="number">99</span> <span class="number">5</span>.<span class="number">47</span> d         -      elastic-data-<span class="number">02</span>b<span class="number">5</span>fb<span class="number">2</span>c<span class="number">632</span>eacc<span class="number">9</span>f-production</span><br><span class="line"><span class="attribute">172</span>.<span class="number">21</span>.<span class="number">39</span>.<span class="number">249</span> <span class="number">172.21.39.249</span>           <span class="number">61</span>          <span class="number">99</span> <span class="number">4</span>.<span class="number">11</span> d         -      elastic-data-<span class="number">09512</span>dff<span class="number">9</span>c<span class="number">057</span>e<span class="number">62</span>b-production</span><br></pre></td></tr></table></figure>

<h2 id="Stucked-nodes"><a href="#Stucked-nodes" class="headerlink" title="Stucked nodes"></a>Stucked nodes</h2><p>We have come across an issue where one or more nodes get stucked, preventing the master from reallocating shards properly. This has happened multiple times. To find out which nodes are stucked you can either search for the exception <code>ReceiveTimeoutTransportException</code> from logs or search in Kibana if applicable.</p>
<h2 id="Decomissioning-Node"><a href="#Decomissioning-Node" class="headerlink" title="Decomissioning Node"></a>Decomissioning Node</h2><p>Node decomission is something you do when you “empty” a node, a.k.a, force shard reallocation. To do that just use one of the commands bellow, depending whether you want to exclude a node by <code>ip</code> or by <code>name</code>. Using <code>name</code> is the preferred way.</p>
<p>Both attributes, ip or name, can be retrieved from the <code>cat-nodes</code> alias mentioned above. You usually want to do this for one host at a time.</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exclude by IP</span></span><br><span class="line">curl -XPUT localhost:9200/_cluster/settings -d &#x27;&#123;</span><br><span class="line">  &quot;<span class="attribute">transient&quot;</span> :&#123;</span><br><span class="line">      &quot;cluster<span class="variable">.routing</span><span class="variable">.allocation</span><span class="variable">.exclude</span><span class="variable">._ip</span>&quot; : &quot;172.19.22.9&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;&#x27;</span><br><span class="line"></span><br><span class="line"># exclude by NAME</span><br><span class="line">curl -XPUT localhost:9200/_cluster/settings -d &#x27;&#123;</span><br><span class="line">  &quot;transient&quot; :&#123;</span><br><span class="line">      &quot;cluster<span class="variable">.routing</span><span class="variable">.allocation</span><span class="variable">.exclude</span><span class="variable">._name</span>&quot; : &quot;elastic-data-05a4f739b4b5fc4ab&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>More info could be found: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L2FsbG9jYXRpb24tZmlsdGVyaW5nLmh0bWw=" title="https://www.elastic.co/guide/en/elasticsearch/reference/current/allocation-filtering.html">ElasticSearch - cluster-level shard allocation-filtering<i class="fa fa-external-link"></i></span></p>
<h2 id="Rolling-restart"><a href="#Rolling-restart" class="headerlink" title="Rolling restart"></a>Rolling restart</h2><ol>
<li>Disable shard allocation</li>
</ol>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT localhost:<span class="number">9200</span>/_cluster/settings -d &#x27;&#123;</span><br><span class="line"><span class="string">&quot;transient&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;cluster.routing.allocation.enable&quot;</span> : &quot;<span class="type">none</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>Stop node (check the alias command on the host to stop a node)</p>
</li>
<li><p>Perform maintenance / upgrade</p>
</li>
<li><p>Restart the node, and confirm that it joined the cluster.</p>
</li>
<li><p>Re-enable shard allocation as follows:</p>
</li>
</ol>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT localhost:<span class="number">9200</span>/_cluster/settings -d &#x27;&#123;</span><br><span class="line"><span class="string">&quot;transient&quot;</span> : &#123;</span><br><span class="line"><span class="string">&quot;cluster.routing.allocation.enable&quot;</span> : &quot;<span class="type">all</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>The above steps can also be done from <code>ansible playbook</code> as follows:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Perform</span> <span class="string">a</span> <span class="string">rolling</span> <span class="string">restart</span> <span class="string">of</span> <span class="string">an</span> <span class="string">Elasticsearch</span> <span class="string">cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">elastic-client-es7:elastic-master-es7:elastic-data-warm-es7:elastic-data-hot-es7</span></span><br><span class="line">  <span class="attr">serial:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vars_prompt:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;service&quot;</span></span><br><span class="line">      <span class="attr">prompt:</span> <span class="string">&quot;Enter the cluster name (eg. A|B|C)&quot;</span></span><br><span class="line">      <span class="attr">private:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">default:</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">es_disable_allocation:</span> <span class="string">&#x27;&#123;&quot;transient&quot;:&#123;&quot;cluster.routing.allocation.enable&quot;: &quot;none&quot;&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">es_enable_allocation:</span> <span class="string">&#x27;&#123;&quot;transient&quot;:&#123;&quot;cluster.routing.allocation.enable&quot;: &quot;all&quot;&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="attr">es_http_port:</span> <span class="number">9200</span></span><br><span class="line">    <span class="attr">es_transport_port:</span> <span class="number">9300</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ensure</span> <span class="string">Elasticsearch</span> <span class="string">is</span> <span class="string">running</span> <span class="string">on</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=elasticsearch-&#123;&#123;</span> <span class="string">service</span> <span class="string">&#125;&#125;</span> <span class="string">enabled=yes</span> <span class="string">state=started</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">response</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">node</span> <span class="string">to</span> <span class="string">come</span> <span class="string">back</span> <span class="string">up</span> <span class="string">if</span> <span class="string">it</span> <span class="string">was</span> <span class="string">stopped</span></span><br><span class="line">      <span class="attr">wait_for:</span> <span class="string">port=&#123;&#123;</span> <span class="string">es_transport_port</span> <span class="string">&#125;&#125;</span> <span class="string">delay=45</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">response.changed</span> <span class="string">==</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># the ansible the uri action needs httplib2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">python-httplib2</span> <span class="string">is</span> <span class="string">installed</span></span><br><span class="line">      <span class="attr">apt:</span> <span class="string">name=python-httplib2</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">current</span> <span class="string">version</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">url=http://localhost:&#123;&#123;</span> <span class="string">es_http_port</span> <span class="string">&#125;&#125;</span> <span class="string">method=GET</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">version_found</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Display</span> <span class="string">current</span> <span class="string">Elasticsearch</span> <span class="string">version</span></span><br><span class="line">      <span class="attr">debug:</span> <span class="string">var=version_found.json.version.number</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># enable first - in case the shards were disabled before for some reason.</span></span><br><span class="line">    <span class="comment"># it&#x27;s important because the next task will wait for the cluster to become green.</span></span><br><span class="line">    <span class="comment"># If the shard allocation is disabled the cluster will stay yellow and the tasks will hang until it times out.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Enable</span> <span class="string">shard</span> <span class="string">allocation</span> <span class="string">for</span> <span class="string">the</span> &#123;&#123; <span class="string">service</span> &#125;&#125; <span class="string">cluster</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://localhost:&#123;&#123;</span> <span class="string">es_http_port</span> <span class="string">&#125;&#125;/_cluster/settings</span></span><br><span class="line">        <span class="attr">method:</span> <span class="string">PUT</span></span><br><span class="line">        <span class="attr">body_format:</span> <span class="string">json</span></span><br><span class="line">        <span class="attr">body:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; es_enable_allocation &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">cluster</span> <span class="string">health</span> <span class="string">to</span> <span class="string">return</span> <span class="string">to</span> <span class="string">green</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://localhost:&#123;&#123;</span> <span class="string">es_http_port</span> <span class="string">&#125;&#125;/_cluster/health</span></span><br><span class="line">        <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">response</span></span><br><span class="line">      <span class="attr">until:</span> <span class="string">&quot;response.json.status == &#x27;green&#x27;&quot;</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">500</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Disable</span> <span class="string">shard</span> <span class="string">allocation</span> <span class="string">for</span> <span class="string">the</span> &#123;&#123; <span class="string">service</span> &#125;&#125; <span class="string">cluster</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://localhost:&#123;&#123;</span> <span class="string">es_http_port</span> <span class="string">&#125;&#125;/_cluster/settings</span></span><br><span class="line">        <span class="attr">method:</span> <span class="string">PUT</span></span><br><span class="line">        <span class="attr">body_format:</span> <span class="string">json</span></span><br><span class="line">        <span class="attr">body:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; es_disable_allocation &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">elasticsearch-&#123;&#123;</span> <span class="string">service</span> <span class="string">&#125;&#125;</span> <span class="string">on</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=elasticsearch-&#123;&#123;</span> <span class="string">service</span> <span class="string">&#125;&#125;</span> <span class="string">enabled=yes</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">node</span> <span class="string">to</span> <span class="string">come</span> <span class="string">back</span> <span class="string">up</span></span><br><span class="line">      <span class="attr">wait_for:</span> <span class="string">port=&#123;&#123;</span> <span class="string">es_transport_port</span> <span class="string">&#125;&#125;</span> <span class="string">delay=35</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">http</span> <span class="string">to</span> <span class="string">come</span> <span class="string">back</span> <span class="string">up</span></span><br><span class="line">      <span class="attr">wait_for:</span> <span class="string">port=&#123;&#123;</span> <span class="string">es_http_port</span> <span class="string">&#125;&#125;</span> <span class="string">delay=5</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">cluster</span> <span class="string">health</span> <span class="string">to</span> <span class="string">return</span> <span class="string">to</span> <span class="string">yellow</span> <span class="string">or</span> <span class="string">green</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">url=http://localhost:&#123;&#123;</span> <span class="string">es_http_port</span> <span class="string">&#125;&#125;/_cluster/health</span> <span class="string">method=GET</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">response</span></span><br><span class="line">      <span class="attr">until:</span> <span class="string">&quot;response.json.status == &#x27;yellow&#x27; or response.json.status == &#x27;green&#x27;&quot;</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">500</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Re-enable</span> <span class="string">shard</span> <span class="string">allocation</span> <span class="string">for</span> <span class="string">the</span> &#123;&#123; <span class="string">service</span> &#125;&#125; <span class="string">cluster</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://localhost:&#123;&#123;</span> <span class="string">es_http_port</span> <span class="string">&#125;&#125;/_cluster/settings</span></span><br><span class="line">        <span class="attr">method:</span> <span class="string">PUT</span></span><br><span class="line">        <span class="attr">body_format:</span> <span class="string">json</span></span><br><span class="line">        <span class="attr">body:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; es_enable_allocation &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">response</span></span><br><span class="line">      <span class="attr">until:</span> <span class="string">&quot;response.json.acknowledged == true&quot;</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">the</span> <span class="string">node</span> <span class="string">to</span> <span class="string">recover</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://localhost:&#123;&#123;</span> <span class="string">es_http_port</span> <span class="string">&#125;&#125;/_cat/health</span></span><br><span class="line">        <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">        <span class="attr">return_content:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">response</span></span><br><span class="line">      <span class="attr">until:</span> <span class="string">&quot;&#x27;green&#x27; in response.content&quot;</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">500</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<p>Then we can run the ansible playbook to perform the rolling restart for Elasticsearch</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook <span class="string">\</span></span><br><span class="line">	-i inventory/aws/production/a-us-west-<span class="number">2</span> <span class="string">\</span></span><br><span class="line">	--ask-become-pass <span class="string">\</span></span><br><span class="line">	playbooks/restart_elasticsearch_es7.yml</span><br></pre></td></tr></table></figure>
    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="David Lu WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="David Lu Alipay">
        <p>Alipay</p>
      </div>

  </div>
</div>

        

  <div class="followme">
    <p>Welcome to my other publishing channels</p>

    <div class="social-list">

            <div class="social-item">
              <a target="_blank" class="social-link" href="https://twitter.com/davidlu1001">
                <span class="icon">
                  <i class="fa fa-twitter"></i>
                </span>

                <span class="label">Twitter</span>
              </a>
            </div>

            <div class="social-item">
              <a target="_blank" class="social-link" href="https://t.me/nztrain">
                <span class="icon">
                  <i class="fa fa-telegram"></i>
                </span>

                <span class="label">Telegram</span>
              </a>
            </div>

            <div class="social-item">
              <a target="_blank" class="social-link" href="/images/wechat_channel.jpg">
                <span class="icon">
                  <i class="fa fa-wechat"></i>
                </span>

                <span class="label">WeChat</span>
              </a>
            </div>

            <div class="social-item">
              <a target="_blank" class="social-link" href="/atom.xml">
                <span class="icon">
                  <i class="fa fa-rss"></i>
                </span>

                <span class="label">RSS</span>
              </a>
            </div>
    </div>
  </div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/ElasticSearch/" rel="tag"><i class="fa fa-tag"></i> ElasticSearch</a>
              <a href="/tags/SRE/" rel="tag"><i class="fa fa-tag"></i> SRE</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/04/13/Continuous-Delivery-Performance-Testing/" rel="prev" title="Continuous Delivery Performance Testing">
      <i class="fa fa-chevron-left"></i> Continuous Delivery Performance Testing
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/04/20/Cost-Optimization-cases-on-AWS/" rel="next" title="Real-life AWS infrastructure Cost Optimization cases">
      Real-life AWS infrastructure Cost Optimization cases <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Handy-aliases"><span class="nav-number">1.</span> <span class="nav-text">Handy aliases</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cheatsheet"><span class="nav-number">2.</span> <span class="nav-text">Cheatsheet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Node-types"><span class="nav-number">3.</span> <span class="nav-text">Node types</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cluster-health"><span class="nav-number">4.</span> <span class="nav-text">Cluster health</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tailing-logs"><span class="nav-number">5.</span> <span class="nav-text">Tailing logs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Listing-allocations"><span class="nav-number">6.</span> <span class="nav-text">Listing allocations</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deleting-corrupted-lost-shards"><span class="nav-number">7.</span> <span class="nav-text">Deleting corrupted &#x2F; lost shards</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Listing-nodes"><span class="nav-number">8.</span> <span class="nav-text">Listing nodes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Stucked-nodes"><span class="nav-number">9.</span> <span class="nav-text">Stucked nodes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Decomissioning-Node"><span class="nav-number">10.</span> <span class="nav-text">Decomissioning Node</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rolling-restart"><span class="nav-number">11.</span> <span class="nav-text">Rolling restart</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">David Lu</p>
  <div class="site-description" itemprop="description">Technology enthusiast</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RhdmlkbHUxMDAx" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;davidlu1001"><i class="fa fa-fw fa-github"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9kYXZpZGx1MTAwMQ==" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;davidlu1001"><i class="fa fa-fw fa-twitter"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmRhdmlkbHUxMDAxQGdtYWlsLmNvbQ==" title="E-Mail → mailto:davidlu1001@gmail.com"><i class="fa fa-fw fa-envelope"></i></span>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Lu</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="Symbols count total">101k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">1:32</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://davidlu1001.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://davidlu1001.github.io/2020/04/16/ElasticSearch-Runbook/";
    this.page.identifier = "2020/04/16/ElasticSearch-Runbook/";
    this.page.title = "ElasticSearch Runbook";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://davidlu1001.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
