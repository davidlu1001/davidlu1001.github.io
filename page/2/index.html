<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="AIn6RYiH7oyvpWJuW_neCErD4pn7Iy9IcaCwwDr7wJg">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"davidlu1001.github.io","root":"/","scheme":"Pisces","version":"7.7.2","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Technology enthusiast">
<meta property="og:type" content="website">
<meta property="og:title" content="Davidlu&#39;s Blog">
<meta property="og:url" content="http://davidlu1001.github.io/page/2/index.html">
<meta property="og:site_name" content="Davidlu&#39;s Blog">
<meta property="og:description" content="Technology enthusiast">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="David Lu">
<meta property="article:tag" content="DevOps, SRE, Python, Big Data, Cloud, AWS, CNCF">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://davidlu1001.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false
  };
</script>

  <title>Davidlu's Blog - DevOps / SRE</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-62146539-2"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-62146539-2');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Davidlu's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Davidlu's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">DevOps / SRE</h1>
      
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">26</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">17</span></a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>Sitemap</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="search-pop-overlay">
  <div class="popup search-popup">
      <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

  </div>
</div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://davidlu1001.github.io/2019/11/22/Zookeeper-Upgrade-Checklist/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="David Lu">
      <meta itemprop="description" content="Technology enthusiast">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Davidlu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/22/Zookeeper-Upgrade-Checklist/" class="post-title-link" itemprop="url">Zookeeper Upgrade Checklist</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-22 20:35:46" itemprop="dateCreated datePublished" datetime="2019-11-22T20:35:46+13:00">2019-11-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SRE/" itemprop="url" rel="index"><span itemprop="name">SRE</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ZooKeeper/" itemprop="url" rel="index"><span itemprop="name">ZooKeeper</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/11/22/Zookeeper-Upgrade-Checklist/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/22/Zookeeper-Upgrade-Checklist/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Just making some notes for the upgrade steps for Zookeeper as a memo.</p>
<h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><ul>
<li>Terraform work complete to create Zookeeper Auto Scaling Group (ASG)</li>
</ul>
<h2 id="Autoscaling"><a href="#Autoscaling" class="headerlink" title="Autoscaling"></a>Autoscaling</h2><p>Full autoscaling Zookeeper (actually adding new nodes to the Zookeeper ensemble automatically) is a bit tricky currently as a full rolling restart of the Zookeeper cluster would have to be orchestrated without ever losing quorum. Zookeeper 3.5 introduced <span class="exturl" data-url="aHR0cHM6Ly96b29rZWVwZXIuYXBhY2hlLm9yZy9kb2MvcjMuNS41L3pvb2tlZXBlclJlY29uZmlnLmh0bWw=" title="https://zookeeper.apache.org/doc/r3.5.5/zookeeperReconfig.html">dynamic reconfiguration<i class="fa fa-external-link"></i></span> which would most likely make this significantly easier. There are some other options for <span class="exturl" data-url="aHR0cHM6Ly93d3cuY3JlZGVyYS5jb20vYmxvZy90ZWNobm9sb2d5LXNvbHV0aW9ucy9ob3ctdG8tYXV0b21hdGUtem9va2VlcGVyLWluLWF3cy8=" title="https://www.credera.com/blog/technology-solutions/how-to-automate-zookeeper-in-aws/">autoscaling Zookeeper 3.4<i class="fa fa-external-link"></i></span> but we’d need to weigh up whether that additional complexity is really worth it.</p>
<h2 id="Puppet"><a href="#Puppet" class="headerlink" title="Puppet"></a>Puppet</h2><p>Using the puppet module: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RlcmljL3B1cHBldC16b29rZWVwZXI=" title="https://github.com/deric/puppet-zookeeper">deric/puppet-zookeeper<i class="fa fa-external-link"></i></span></p>
<h3 id="Updating-Hiera-Puppet"><a href="#Updating-Hiera-Puppet" class="headerlink" title="Updating Hiera / Puppet"></a>Updating Hiera / Puppet</h3><p>When a new node starts within the ASG Puppet will run but Zookeeper will not be started automatically. Hiera will need to be updated and Puppet run again for Zookeeper to start.</p>
<p>“zookeeper::servers” - Needs to be set to a hash of the complete list of servers in the Zookeeper ensemble. This is typically set at the “dc” level in the hierarchy, e.g.</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">puppet</span>/hieradata-masterless/dc</span><br><span class="line"></span><br><span class="line"><span class="attribute">cat</span> test-us-west-<span class="number">2</span>.yaml</span><br><span class="line"><span class="attribute">zookeeper</span>::servers:</span><br><span class="line">  <span class="attribute">100</span>: zookeeper-<span class="number">0</span>cdf<span class="number">08</span>e<span class="number">0</span>d<span class="number">09</span>dd<span class="number">3530</span>.oregon.test.xyz.org</span><br><span class="line">  <span class="attribute">101</span>: zookeeper-<span class="number">01</span>ff<span class="number">482</span>cf<span class="number">77636240</span>.oregon.test.xyz.org</span><br><span class="line">  <span class="attribute">102</span>: zookeeper-<span class="number">0749</span>d<span class="number">84</span>c<span class="number">7</span>dfd<span class="number">4</span>d<span class="number">798</span>.oregon.test.xyz.org</span><br></pre></td></tr></table></figure>

<p>“zookeeper::id” - Needs to be set to the unique ID of the node within the Zookeeper cluster. This is set at the node level (as it’s always specific to a particular node) and needs to match with one (and only one) entry in “zookeeper::servers”. The corresponding node configuration for the above “zookeeper::servers” configuration would be</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">puppet</span>/hieradata-masterless/nodes</span><br><span class="line"></span><br><span class="line"><span class="attribute">cat</span> zookeeper-<span class="number">0</span>cdf<span class="number">08</span>e<span class="number">0</span>d<span class="number">09</span>dd<span class="number">3530</span>.yaml</span><br><span class="line"><span class="attribute">zookeeper</span>::id: <span class="number">100</span></span><br><span class="line"> </span><br><span class="line"><span class="attribute">cat</span> zookeeper-<span class="number">01</span>ff<span class="number">482</span>cf<span class="number">77636240</span>.yaml</span><br><span class="line"><span class="attribute">zookeeper</span>::id: <span class="number">101</span></span><br><span class="line"> </span><br><span class="line"><span class="attribute">cat</span> zookeeper-<span class="number">0749</span>d<span class="number">84</span>c<span class="number">7</span>dfd<span class="number">4</span>d<span class="number">798</span>.yaml</span><br><span class="line"><span class="attribute">zookeeper</span>::id: <span class="number">102</span></span><br></pre></td></tr></table></figure>

<h1 id="Migration-steps"><a href="#Migration-steps" class="headerlink" title="Migration steps"></a>Migration steps</h1><ul>
<li>Adding additional nodes to expand the existing ensemble. Must be repeated once for each new node<ul>
<li>Start Zookeeper on one of the replacement nodes. The node should join the ensemble as a follower.</li>
<li>Execute a Puppet run on each of the existing nodes one at a time. Restart the nodes in order with the lowest ZKID first but restart the leader last.</li>
<li>Ensure the nodes are all in sync</li>
</ul>
</li>
<li>Once the ensemble has been expanded and is in sync the original Trusty nodes can be removed. Starting with an ensemble of six nodes:<ul>
<li>Stop Zookeeper on one of the original nodes</li>
<li>Update the list of servers on the remaining nodes to remove the server that has been stopped.</li>
<li>Rolling restart of the cluster with the nodes in order from lowest to highest ZKID. The leader should be restarted last. At this point the ensemble should consist of five nodes.</li>
<li>Stop Zookeeper on the final two original Trusty nodes. The three replacement nodes left on line can still form a quorum and should continue to work as expected.</li>
<li>Update the list of servers on the remaining nodes to remove the servers that have been stopped.</li>
<li>Rolling restart of the cluster with the nodes in order from lowest to highest ZKID. The leader should be restarted last. At this point the ensemble should consist of three nodes.</li>
</ul>
</li>
</ul>
<h1 id="Tidy-up"><a href="#Tidy-up" class="headerlink" title="Tidy up"></a>Tidy up</h1><p>once we’re certain that we’re never going to revert to the original nodes</p>
<ul>
<li>Ensure replacement nodes are being monitored by Datadog</li>
<li>Ensure replacement nodes are sending logs to the Elastic lifesupport cluster</li>
<li>Ensure bash aliases are updated</li>
<li>Terraform work to decommission original nodes</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://davidlu1001.github.io/2019/11/12/ElasticSearch-Migration-to-AWS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="David Lu">
      <meta itemprop="description" content="Technology enthusiast">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Davidlu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/12/ElasticSearch-Migration-to-AWS/" class="post-title-link" itemprop="url">ElasticSearch migrated from EC2 to AWS managed ES</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-12 21:07:58" itemprop="dateCreated datePublished" datetime="2019-11-12T21:07:58+13:00">2019-11-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AWS/" itemprop="url" rel="index"><span itemprop="name">AWS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SRE/" itemprop="url" rel="index"><span itemprop="name">SRE</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ElasticSearch/" itemprop="url" rel="index"><span itemprop="name">ElasticSearch</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/11/12/ElasticSearch-Migration-to-AWS/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/12/ElasticSearch-Migration-to-AWS/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>8.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><p>Let’s say there’s a legacy platform called XXX, and it still poses an operational cost for SRE to manage the monitoring / alerting / upgrade etc.</p>
<p>At present, XXX’s ElasticSearch architecture consists of 3 hosts (m4.xlarge) acting as master, client and data nodes, for XXX’s searching functionality.</p>
<p>All of them are using Ubuntu Trusty (14.04) image, which is no longer supported and need to be migrated to Xenial (16.04). Its usage seems pretty low and cost wise so we would like to migrate the XXX ES to AWS managed ElasticSearch Service to reduce operational overhead.</p>
<p>This doc will cover the project plan / checklist for migration.</p>
<h1 id="Solution-overview"><a href="#Solution-overview" class="headerlink" title="Solution overview"></a>Solution overview</h1><p>Elasticsearch (ES) indexes can be migrated with following steps:</p>
<ul>
<li><p>Create baseline indexes</p>
<ul>
<li>Create a snapshot repository and associate it to an AWS S3 Bucket.</li>
<li>Create the first snapshot of the indexes to be migrated, which is a full snapshot on EC2 - The snapshot will be automatically stored in the AWS S3 bucket created in the first step.</li>
<li>Restore this full snapshot to the AWS ES.</li>
</ul>
</li>
<li><p>Periodic incremental snapshots</p>
<ul>
<li>Repeat serval incremental snapshot and restore.</li>
</ul>
</li>
<li><p>Final snapshot and service switchover</p>
<ul>
<li>Stop services which can modify index data.</li>
<li>Create a final incremental snapshot of the EC2.</li>
<li>Perform service switchover to the AWS ES.</li>
</ul>
</li>
</ul>
<h1 id="Checklist"><a href="#Checklist" class="headerlink" title="Checklist"></a>Checklist</h1><p>Here’s a list of what will we do in detail:</p>
<h2 id="Assess-and-analyse-current-data"><a href="#Assess-and-analyse-current-data" class="headerlink" title="Assess and analyse current data"></a>Assess and analyse current data</h2><p>The ES data is around 30G, setting <code>number_of_replicas</code> to 1, then according to the <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2VsYXN0aWNzZWFyY2gtc2VydmljZS9sYXRlc3QvZGV2ZWxvcGVyZ3VpZGUvc2l6aW5nLWRvbWFpbnMuaHRtbA==" title="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/sizing-domains.html">simplified version of calculation<i class="fa fa-external-link"></i></span>:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Source</span> Data * (<span class="number">1</span> + Number of Replicas) * <span class="number">1</span>.<span class="number">45</span> = Minimum Storage Requirement</span><br></pre></td></tr></table></figure>

<p>So the minimum storage for AWS managed ES is about 90G.</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">curl</span> $es/_cat/indices?v</span><br><span class="line"><span class="attribute">health</span> status index              pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line"><span class="attribute">green</span>  open   .marvel-<span class="number">2019</span>.<span class="number">10</span>.<span class="number">12</span>   <span class="number">1</span>   <span class="number">1</span>     <span class="number">115081</span>            <span class="number">0</span>      <span class="number">413</span>mb        <span class="number">206</span>.<span class="number">3</span>mb</span><br><span class="line"><span class="attribute">green</span>  open   site-<span class="number">1</span>.<span class="number">0</span>           <span class="number">200</span>   <span class="number">1</span>     <span class="number">937559</span>          <span class="number">884</span>      <span class="number">1</span>.<span class="number">6</span>gb        <span class="number">848</span>.<span class="number">7</span>mb</span><br><span class="line"><span class="attribute">green</span>  open   site_v<span class="number">1</span>            <span class="number">200</span>   <span class="number">1</span>     <span class="number">324638</span>           <span class="number">33</span>    <span class="number">335</span>.<span class="number">8</span>mb        <span class="number">167</span>.<span class="number">9</span>mb</span><br><span class="line"><span class="attribute">green</span>  open   .marvel-<span class="number">2019</span>.<span class="number">10</span>.<span class="number">14</span>   <span class="number">1</span>   <span class="number">1</span>     <span class="number">115009</span>            <span class="number">0</span>    <span class="number">424</span>.<span class="number">5</span>mb        <span class="number">212</span>.<span class="number">2</span>mb</span><br><span class="line"><span class="attribute">green</span>  open   .marvel-<span class="number">2019</span>.<span class="number">10</span>.<span class="number">15</span>   <span class="number">1</span>   <span class="number">1</span>     <span class="number">114962</span>            <span class="number">0</span>    <span class="number">424</span>.<span class="number">7</span>mb          <span class="number">212</span>mb</span><br><span class="line"><span class="attribute">green</span>  open   .marvel-<span class="number">2019</span>.<span class="number">10</span>.<span class="number">16</span>   <span class="number">1</span>   <span class="number">1</span>      <span class="number">14290</span>            <span class="number">0</span>     <span class="number">56</span>.<span class="number">3</span>mb         <span class="number">28</span>.<span class="number">3</span>mb</span><br><span class="line"><span class="attribute">green</span>  open   .marvel-<span class="number">2019</span>.<span class="number">10</span>.<span class="number">13</span>   <span class="number">1</span>   <span class="number">1</span>     <span class="number">115104</span>            <span class="number">0</span>    <span class="number">410</span>.<span class="number">5</span>mb          <span class="number">205</span>mb</span><br><span class="line"><span class="attribute">green</span>  open   search             <span class="number">200</span>   <span class="number">1</span>   <span class="number">20829799</span>      <span class="number">6167280</span>       <span class="number">24</span>gb           <span class="number">12</span>gb</span><br><span class="line"><span class="attribute">green</span>  open   .marvel-kibana       <span class="number">1</span>   <span class="number">1</span>          <span class="number">1</span>            <span class="number">0</span>      <span class="number">6</span>.<span class="number">4</span>kb          <span class="number">3</span>.<span class="number">2</span>kb</span><br></pre></td></tr></table></figure>

<h2 id="Create-an-S3-bucket-for-current-Elasticsearch-data-on-EC2"><a href="#Create-an-S3-bucket-for-current-Elasticsearch-data-on-EC2" class="headerlink" title="Create an S3 bucket for current Elasticsearch data (on EC2)"></a>Create an S3 bucket for current Elasticsearch data (on EC2)</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">e</span>.g. s<span class="number">3</span>://es-backup (us-west-<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Make-ES-Cluster-snapshot-and-move-it-to-S3"><a href="#Make-ES-Cluster-snapshot-and-move-it-to-S3" class="headerlink" title="Make ES Cluster snapshot and move it to S3"></a>Make ES Cluster snapshot and move it to S3</h2><ul>
<li><p>check snapshot repository setttings</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:<span class="number">9200</span>/_snapshot?pretty</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;XXX-snapshot-s3-repo&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span> : &quot;<span class="type">s3</span><span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>settings<span class="string">&quot; : &#123;</span></span><br><span class="line"><span class="string">      &quot;</span>bucket<span class="string">&quot; : &quot;</span>es-backup<span class="string">&quot;,</span></span><br><span class="line"><span class="string">      &quot;</span>region<span class="string">&quot; : &quot;</span>us-west-<span class="number">2</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>set snapshot repo to S3</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT localhost:<span class="number">9200</span>/_snapshot/XXX-snapshot-s3-repo?verify=false -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;</span><span class="built_in">type</span><span class="string">&quot;: &quot;</span>s3<span class="string">&quot;,</span></span><br><span class="line"><span class="string">  &quot;</span>settings<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;</span>bucket<span class="string">&quot;: &quot;</span>es-backup<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>region<span class="string">&quot;: &quot;</span>us-west<span class="number">-2</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>check indices</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:<span class="number">9200</span><span class="regexp">/_cat/i</span>ndices?pretty</span><br></pre></td></tr></table></figure>
</li>
<li><p>make snapshots</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># specified indices</span></span><br><span class="line">curl -XPUT <span class="string">&quot;localhost:9200/_snapshot/XXX-snapshot-s3-repo/marvel-20191101?wait_for_completion=true&quot;</span> -d &#x27;&#123;</span><br><span class="line">  <span class="string">&quot;indices&quot;</span>: <span class="string">&quot;.marvel-2019.11.01&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ignore_unavailable&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">  <span class="string">&quot;include_global_state&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;&#x27;</span><br><span class="line"> </span><br><span class="line">&#123;<span class="string">&quot;snapshot&quot;</span>:&#123;<span class="string">&quot;snapshot&quot;</span>:<span class="string">&quot;marvel-20191024&quot;</span>,<span class="string">&quot;indices&quot;</span>:[<span class="string">&quot;.marvel-2019.10.24&quot;</span>],<span class="string">&quot;state&quot;</span>:<span class="string">&quot;SUCCESS&quot;</span>,<span class="string">&quot;start_time&quot;</span>:<span class="string">&quot;2019-10-25T00:20:47.625Z&quot;</span>,<span class="string">&quot;start_time_in_millis&quot;</span>:<span class="number">1571962847625</span>,<span class="string">&quot;end_time&quot;</span>:<span class="string">&quot;2019-10-25T00:21:06.058Z&quot;</span>,<span class="string">&quot;end_time_in_millis&quot;</span>:<span class="number">1571962866058</span>,<span class="string">&quot;duration_in_millis&quot;</span>:<span class="number">18433</span>,<span class="string">&quot;failures&quot;</span>:[],<span class="string">&quot;shards&quot;</span>:&#123;<span class="string">&quot;total&quot;</span>:<span class="number">1</span>,<span class="string">&quot;failed&quot;</span>:<span class="number">0</span>,<span class="string">&quot;successful&quot;</span>:<span class="number">1</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>check snapshots</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check snapshots</span></span><br><span class="line"> </span><br><span class="line">curl localhost:<span class="number">9200</span><span class="regexp">/_snapshot/</span>XXX-snapshot-s3-repo/_all?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;snapshots&quot;</span> : [ &#123;</span><br><span class="line">    <span class="string">&quot;snapshot&quot;</span> : <span class="string">&quot;marvel-20191016_20191018&quot;</span>,</span><br><span class="line">    <span class="string">&quot;indices&quot;</span> : [ <span class="string">&quot;site_v1&quot;</span> ],</span><br><span class="line">    <span class="string">&quot;state&quot;</span> : <span class="string">&quot;SUCCESS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;start_time&quot;</span> : <span class="string">&quot;2019-10-18T01:56:21.344Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;start_time_in_millis&quot;</span> : <span class="number">1571363781344</span>,</span><br><span class="line">    <span class="string">&quot;end_time&quot;</span> : <span class="string">&quot;2019-10-18T01:57:56.012Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;end_time_in_millis&quot;</span> : <span class="number">1571363876012</span>,</span><br><span class="line">    <span class="string">&quot;duration_in_millis&quot;</span> : <span class="number">94668</span>,</span><br><span class="line">    <span class="string">&quot;failures&quot;</span> : [ ],</span><br><span class="line">    <span class="string">&quot;shards&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;total&quot;</span> : <span class="number">200</span>,</span><br><span class="line">      <span class="string">&quot;failed&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="string">&quot;successful&quot;</span> : <span class="number">200</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Create-and-configure-AWS-Elasticsearch-service-version-1-5"><a href="#Create-and-configure-AWS-Elasticsearch-service-version-1-5" class="headerlink" title="Create and configure AWS Elasticsearch service (version 1.5)"></a>Create and configure AWS Elasticsearch service (version 1.5)</h2><h2 id="Migrate-the-data-Restore-cluster-from-S3-to-AWS-ES"><a href="#Migrate-the-data-Restore-cluster-from-S3-to-AWS-ES" class="headerlink" title="Migrate the data (Restore cluster from S3 to AWS ES)"></a>Migrate the data (Restore cluster from S3 to AWS ES)</h2><ul>
<li><p>check current iam instance profile role on XXX ES hosts</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">aws</span> <span class="string">sts</span> <span class="built_in">get-caller-identity</span></span><br><span class="line"><span class="built_in">&#123;</span></span><br><span class="line"><span class="built_in"></span>    <span class="string">&quot;Account&quot;</span>: <span class="string">&quot;XXXXXXXXXXX&quot;</span>,</span><br><span class="line">    <span class="string">&quot;UserId&quot;</span>: <span class="string">&quot;AROAISLXH37RO7WDQU7H2:i-f9f6cf20&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:sts::XXXXXXXXXXX:assumed-role/elasticsearch-cloud-aws/i-f9f6cf20&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>set snapshot repository for AWS managed ES</p>
</li>
</ul>
<p>Must sign your snapshot requests, if your access policies specify IAM users or roles.</p>
<p>p.s. If using curl will get the following error message:</p>
<blockquote>
<p>{“Message”:”User: anonymous is not authorized to perform: iam:PassRole on resource: arn:aws:iam::XXXXXXXXXXX:role/test-role”}</p>
</blockquote>
<p>Example code:</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">python register_es_repo.py</span><br><span class="line"> </span><br><span class="line"><span class="built_in">import</span> boto3</span><br><span class="line"><span class="built_in">import</span> requests</span><br><span class="line"><span class="built_in">import</span> json</span><br><span class="line">from requests_aws4auth <span class="built_in">import</span> AWS4Auth</span><br><span class="line"> </span><br><span class="line"><span class="attr">host</span> = &#x27;https://vpc-es-XXX-prod-ji6wgswtt3btfue5pwqwgvudry.us-west-<span class="number">2</span>.es.amazonaws.com/&#x27;</span><br><span class="line"><span class="attr">region</span> = &#x27;us-west-<span class="number">2</span>&#x27;</span><br><span class="line"><span class="attr">service</span> = &#x27;es&#x27;</span><br><span class="line"><span class="attr">credentials</span> = boto3.Session().get_credentials()</span><br><span class="line"><span class="attr">awsauth</span> = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, <span class="attr">session_token=credentials.token)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Register repository</span></span><br><span class="line"><span class="attr">path</span> = &#x27;_snapshot/XXX-snapshot-s3-repo&#x27; <span class="comment"># the Elasticsearch API endpoint</span></span><br><span class="line"><span class="attr">url</span> = host + path</span><br><span class="line"> </span><br><span class="line"><span class="attr">payload</span> = &#123;</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;s3&quot;</span>,</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bucket&quot;</span>: <span class="string">&quot;es-backup&quot;</span>,</span><br><span class="line">    <span class="string">&quot;region&quot;</span>: <span class="string">&quot;us-west-2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;role_arn&quot;</span>: <span class="string">&quot;arn:aws:iam::XXXXXXXXXX:role/elasticsearch-cloud-aws&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="attr">headers</span> = &#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line"> </span><br><span class="line"><span class="attr">r</span> = requests.put(url, <span class="attr">auth=awsauth,</span> <span class="attr">json=payload,</span> <span class="attr">headers=headers)</span></span><br><span class="line"> </span><br><span class="line">print(r.status_code)</span><br><span class="line">print(r.text)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># Output</span></span><br><span class="line"><span class="number">200</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>check snapshot repository settings</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">curl</span> <span class="literal">-XGET</span> <span class="variable">$es</span>/_snapshot?pretty</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;XXX-snapshot-s3-repo&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span> : <span class="string">&quot;s3&quot;</span>,</span><br><span class="line">    <span class="string">&quot;settings&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;bucket&quot;</span> : <span class="string">&quot;es-backup&quot;</span>,</span><br><span class="line">      <span class="string">&quot;role_arn&quot;</span> : <span class="string">&quot;arn:aws:iam::XXXXXXXXXXX:role/aws-elasticsearch-backup&quot;</span>,</span><br><span class="line">      <span class="string">&quot;region&quot;</span> : <span class="string">&quot;us-west-2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>update search index settings to speed up restore process</p>
</li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># https:<span class="comment">//aws.amazon.com/premiumsupport/knowledge-center/elasticsearch-indexing-performance/</span></span></span><br><span class="line"># For huge index, reduce from <span class="number">30</span><span class="built_in">min</span> to <span class="number">10</span><span class="built_in">min</span> together with incremental snapshot:</span><br><span class="line"> </span><br><span class="line"><span class="meta"># before migration</span></span><br><span class="line">curl -XPUT <span class="string">&quot;$es/search/_settings&quot;</span> -d<span class="number">&#x27;</span> &#123;</span><br><span class="line">        <span class="string">&quot;number_of_replicas&quot;</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;refresh_interval&quot;</span> : <span class="string">&quot;-1&quot;</span></span><br><span class="line">&#125;&#x27;</span><br><span class="line"> </span><br><span class="line"><span class="meta"># set it back after migration</span></span><br><span class="line">curl -XPUT <span class="string">&quot;$es/search/_settings&quot;</span> -d<span class="number">&#x27;</span> &#123;</span><br><span class="line">        <span class="string">&quot;number_of_replicas&quot;</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;refresh_interval&quot;</span> : <span class="string">&quot;1s&quot;</span></span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>restore snapshots from S3 into AWS managed ES</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># e.g restore from specific snapshot</span></span><br><span class="line">curl -XPOST <span class="string">&quot;<span class="variable">$es</span>/_snapshot/XXX-snapshot-s3-repo/marvel-20191024/_restore&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># e.g. restore just one index, &quot;.marvel-2019.10.24&quot;, from &quot;marvel-20191024&quot; snapshot in the &quot;XXX-snapshot-s3-repo&quot; snapshot repository:</span></span><br><span class="line">curl -XPOST <span class="string">&quot;<span class="variable">$es</span>/_snapshot/XXX-snapshot-s3-repo/marvel-20191024/_restore&quot;</span> -d <span class="string">&#x27;&#123;&quot;indices&quot;: &quot;.marvel-2019.10.24&quot;&#125;&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># e.g restore all indices except for the .kibana index</span></span><br><span class="line">curl -XPOST <span class="string">&quot;<span class="variable">$es</span>/_snapshot/XXX-snapshot-s3-repo/marvel-20191024/_restore&quot;</span> -d <span class="string">&#x27;&#123;&quot;indices&quot;: &quot;*,-.kibana&quot;&#125;&#x27;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Run <code>es_migrate.sh</code> script to snapshot / restore</p>
</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">time</span> bash -x es_migrate.sh</span><br><span class="line"> </span><br><span class="line"><span class="attribute">real</span>    <span class="number">10</span>m<span class="number">7</span>.<span class="number">667</span>s</span><br><span class="line"><span class="attribute">user</span>    <span class="number">0</span>m<span class="number">0</span>.<span class="number">129</span>s</span><br><span class="line"><span class="attribute">sys</span> <span class="number">0</span>m<span class="number">0</span>.<span class="number">142</span>s</span><br></pre></td></tr></table></figure>

<h2 id="Switch-from-self-hosted-to-AWS-managed-ES"><a href="#Switch-from-self-hosted-to-AWS-managed-ES" class="headerlink" title="Switch from self-hosted to AWS managed ES"></a>Switch from self-hosted to AWS managed ES</h2><p>get ECS task parameter settings and set ES endpoint to AWS managed ES for application</p>
<h2 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h2><ul>
<li>General function testing</li>
<li>Rollback to old ELB in CNAME if errors</li>
<li>Data Integration Check</li>
</ul>
<p>Will generate <code>doc_count</code> diff result for old / new ES (take index <code>.marvel-*</code> for example):</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#index  old_doc_count   new_doc_count   diff_rate</span></span><br><span class="line"> </span><br><span class="line">.marvel-2019.11.08 <span class="number"> 114929 </span>    <span class="number"> 114929 </span>     0.0000%</span><br><span class="line">.marvel-2019.11.09 <span class="number"> 114930 </span>    <span class="number"> 114930 </span>     0.0000%</span><br><span class="line">.marvel-2019.11.10 <span class="number"> 114904 </span>    <span class="number"> 114904 </span>     0.0000%</span><br><span class="line">.marvel-2019.11.11 <span class="number"> 104327 </span>    <span class="number"> 103532 </span>     -0.7620%</span><br><span class="line">search             <span class="number"> 21025214 </span>  <span class="number"> 21025162 </span>   -0.0002%</span><br><span class="line">site-1.0           <span class="number"> 939656 </span>    <span class="number"> 939657 </span>     0.0001%</span><br><span class="line">site_v1            <span class="number"> 324638 </span>    <span class="number"> 324638 </span>     0.0000%</span><br><span class="line"> </span><br><span class="line">real    10m7.303s</span><br><span class="line">user    0m0.156s</span><br><span class="line">sys 0m0.121s</span><br></pre></td></tr></table></figure>

<h2 id="Tidy-up-resources-in-Puppet-Terraform"><a href="#Tidy-up-resources-in-Puppet-Terraform" class="headerlink" title="Tidy up resources in Puppet / Terraform"></a>Tidy up resources in Puppet / Terraform</h2><p>The last step is that clean up old resources in Puppet or Terraform (e.g. EC2 / SG / Route53 etc.)</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><span class="exturl" data-url="aHR0cHM6Ly9hd3MuYW1hem9uLmNvbS9wcmVtaXVtc3VwcG9ydC9rbm93bGVkZ2UtY2VudGVyL2VsYXN0aWNzZWFyY2gtaW5kZXhpbmctcGVyZm9ybWFuY2Uv" title="https://aws.amazon.com/premiumsupport/knowledge-center/elasticsearch-indexing-performance/">knowledge-center/elasticsearch-indexing-performance<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2VsYXN0aWNzZWFyY2gtc2VydmljZS9sYXRlc3QvZGV2ZWxvcGVyZ3VpZGUvc2l6aW5nLWRvbWFpbnMuaHRtbA==" title="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/sizing-domains.html">AWS - sizing domains<i class="fa fa-external-link"></i></span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9tZWRpdW0uY29tL2tyYWtlbnN5c3RlbXMtYmxvZy9taWdyYXRpbmcteW91ci1zZWxmLWhvc3RlZC1lbGFzdGljc2VhcmNoLXRvLWF3cy1lbGFzdGljc2VhcmNoLXNlcnZpY2UtYS1kZXRhaWxlZC1ndWlkZS1mZjIyZWZlZGU1YTM=" title="https://medium.com/krakensystems-blog/migrating-your-self-hosted-elasticsearch-to-aws-elasticsearch-service-a-detailed-guide-ff22efede5a3">Migrating your self-hosted ElasticSearch to AWS ElasticSearch Service<i class="fa fa-external-link"></i></span></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://davidlu1001.github.io/2019/08/13/How-to-use-Terraform-include-exclude/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="David Lu">
      <meta itemprop="description" content="Technology enthusiast">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Davidlu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/13/How-to-use-Terraform-include-exclude/" class="post-title-link" itemprop="url">How to use Terraform include / exclude with Makefile</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-13 21:59:05" itemprop="dateCreated datePublished" datetime="2019-08-13T21:59:05+12:00">2019-08-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SRE/" itemprop="url" rel="index"><span itemprop="name">SRE</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Terraform/" itemprop="url" rel="index"><span itemprop="name">Terraform</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/08/13/How-to-use-Terraform-include-exclude/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/08/13/How-to-use-Terraform-include-exclude/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><p>When using make plan command, if there’re too many resources need to be applied, together with other unrelated resources that we don’t want to touch, then we need to use Terraform <span class="exturl" data-url="aHR0cHM6Ly93d3cudGVycmFmb3JtLmlvL2RvY3MvY29tbWFuZHMvcGxhbi5odG1sI3Jlc291cmNlLXRhcmdldGluZw==" title="https://www.terraform.io/docs/commands/plan.html#resource-targeting">resource targeting<i class="fa fa-external-link"></i></span>:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">PLAN_OPTIONS</span>=<span class="string">&quot;-target=&quot;</span>A&quot; <span class="attribute">-target</span>=<span class="string">&quot;B&quot;</span> <span class="built_in">..</span>. <span class="attribute">-target</span>=<span class="string">&quot;N&quot;</span><span class="string">&quot; make plan</span></span><br></pre></td></tr></table></figure>

<p>But Terraform <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hhc2hpY29ycC90ZXJyYWZvcm0vaXNzdWVzLzIyNTM=" title="https://github.com/hashicorp/terraform/issues/2253">doesn’t support –exclude feature<i class="fa fa-external-link"></i></span> for the target at the moment (and we don’t want to copy &amp; paste over 50 times for the targets), that’s why need to find a way to implement <code>exclude / include</code> features within Makefile.</p>
<h1 id="How-to"><a href="#How-to" class="headerlink" title="How-to"></a>How-to</h1><ul>
<li>make plan</li>
</ul>
<p>Run <code>make plan</code> to show pending changes, also generate <code>current.plan</code> that we use later to filter targets.</p>
<ul>
<li>filter targets</li>
</ul>
<p>Then pick the resources you want by using <code>[INCLUDE | EXCLUDE]</code> which support POSIX Extended Regular Expressions (ERE)</p>
<p>E.g.</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use include to specify only the targets you want to apply</span></span><br><span class="line">$ make plan_include <span class="attribute">INCLUDE</span>=<span class="string">&#x27;mark3a&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># output</span></span><br><span class="line">terraform plan -out current.plan    <span class="attribute">-target</span>=<span class="string">&quot;aws_alb_target_group_attachment.routers-mark3a&quot;</span> <span class="attribute">-target</span>=<span class="string">&quot;module.routers-mark3a.aws_instance.main&quot;</span> <span class="attribute">-target</span>=<span class="string">&quot;module.routers-mark3a.aws_route53_record.main_instance&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># exclude the targets</span></span><br><span class="line">$ make plan_exclude <span class="attribute">EXCLUDE</span>=<span class="string">&#x27;aws_security_group|mark3b&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># output</span></span><br><span class="line">terraform plan -out current.plan    <span class="attribute">-target</span>=<span class="string">&quot;aws_alb_target_group_attachment.routers-mark3a&quot;</span> <span class="attribute">-target</span>=<span class="string">&quot;aws_alb_target_group_attachment.routers-mark3c&quot;</span> <span class="attribute">-target</span>=<span class="string">&quot;module.asg_databus_production.aws_autoscaling_group.main&quot;</span> <span class="attribute">-target</span>=<span class="string">&quot;module.asg_router_production.aws_autoscaling_group.main&quot;</span> <span class="attribute">-target</span>=<span class="string">&quot;module.asg_router_production.aws_launch_configuration.main&quot;</span> <span class="attribute">-target</span>=<span class="string">&quot;module.routers-mark3a.aws_instance.main&quot;</span> <span class="attribute">-target</span>=<span class="string">&quot;module.routers-mark3a.aws_route53_record.main_instance&quot;</span> <span class="attribute">-target</span>=<span class="string">&quot;module.routers-mark3c.aws_instance.main&quot;</span> <span class="attribute">-target</span>=<span class="string">&quot;module.routers-mark3c.aws_route53_record.main_instance&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>make apply</li>
</ul>
<p>Finally can use <code>make apply</code> to apply the changes based on new <code>current.plan</code></p>
<h1 id="Explain"><a href="#Explain" class="headerlink" title="Explain"></a>Explain</h1><p>Show the output generated by <code>make plan</code>, then process the output (e.g. clear ANSI color / match resource names after empty line etc.) to generate the final format (e.g. -target=”A” -target=”B” -target=”C” …)</p>
<p>in Makefile:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">define PLAN_OPTIONS_EXCLUDE</span><br><span class="line">	<span class="constructor">$(<span class="params">shell</span> <span class="params">terraform</span> <span class="params">show</span> <span class="params">current</span>.<span class="params">plan</span> | <span class="params">perl</span> -<span class="params">pe</span> &#x27;<span class="params">s</span><span class="operator">/</span><span class="operator">/</span>\<span class="params">n</span><span class="operator">/</span> <span class="params">if</span> $$. <span class="operator">==</span> 1&#x27; | <span class="params">perl</span> -<span class="params">pe</span> &#x27;<span class="params">s</span><span class="operator">/</span>\<span class="params">x1b</span>\[[0-9;]<span class="operator">*</span>[<span class="params">mG</span>]<span class="operator">/</span><span class="operator">/</span><span class="params">g</span>&#x27; | <span class="params">perl</span> -<span class="params">ne</span> &#x27;<span class="params">if</span> ($$<span class="params">p</span>)</span> &#123; print unless /^$$/; $$p = <span class="number">0</span> &#125; $$p++ <span class="keyword">if</span> /^$$/&#x27;<span class="pattern-match">| awk &#x27;&#123;print <span class="constructor">$$2</span>&#125;&#x27; | grep -<span class="constructor">E</span> -v &#x27;<span class="constructor">$(1)</span>&#x27; | sed -e &#x27;s<span class="operator">/</span>^<span class="operator">/</span>-target=&quot;<span class="operator">/</span>g&#x27; -e &#x27;s<span class="operator">/</span><span class="constructor">$$</span><span class="operator">/</span>&quot;<span class="operator">/</span>g&#x27; | awk <span class="constructor">BEGIN</span>&#123;<span class="constructor">RS</span>=<span class="constructor">EOF</span>&#125;&#x27;&#123;gsub(<span class="operator">/</span>\n<span class="operator">/</span>,&quot; &quot;);print&#125;&#x27;)</span></span><br><span class="line"><span class="pattern-match">endef</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">define <span class="constructor">PLAN_OPTIONS_INCLUDE</span></span></span><br><span class="line"><span class="pattern-match">	<span class="constructor">$(<span class="params">shell</span> <span class="params">terraform</span> <span class="params">show</span> <span class="params">current</span>.<span class="params">plan</span> | <span class="params">perl</span> -<span class="params">pe</span> &#x27;<span class="params">s</span><span class="operator">/</span><span class="operator">/</span>\<span class="params">n</span><span class="operator">/</span> <span class="params">if</span> $$. <span class="operator">==</span> 1&#x27; | <span class="params">perl</span> -<span class="params">pe</span> &#x27;<span class="params">s</span><span class="operator">/</span>\<span class="params">x1b</span>\[[0-9;]<span class="operator">*</span>[<span class="params">mG</span>]<span class="operator">/</span><span class="operator">/</span><span class="params">g</span>&#x27; | <span class="params">perl</span> -<span class="params">ne</span> &#x27;<span class="params">if</span> ($$<span class="params">p</span>)</span> &#123; print unless <span class="operator">/</span>^<span class="constructor">$$</span><span class="operator">/</span>; <span class="constructor">$$p</span> = 0 &#125; <span class="constructor">$$p</span><span class="operator">++</span> <span class="keyword">if</span> <span class="operator">/</span>^<span class="constructor">$$</span><span class="operator">/</span>&#x27;| awk &#x27;&#123;print <span class="constructor">$$2</span>&#125;&#x27; | grep -<span class="constructor">E</span> &#x27;<span class="constructor">$(1)</span>&#x27; | sed -e &#x27;s<span class="operator">/</span>^<span class="operator">/</span>-target=&quot;<span class="operator">/</span>g&#x27; -e &#x27;s<span class="operator">/</span><span class="constructor">$$</span><span class="operator">/</span>&quot;<span class="operator">/</span>g&#x27; | awk <span class="constructor">BEGIN</span>&#123;<span class="constructor">RS</span>=<span class="constructor">EOF</span>&#125;&#x27;&#123;gsub(<span class="operator">/</span>\n<span class="operator">/</span>,&quot; &quot;);print&#125;&#x27;)</span></span><br><span class="line"><span class="pattern-match">endef</span></span><br></pre></td></tr></table></figure>

<p>and then the macro <code>PLAN_OPTIONS_EXCLUDE</code> / <code>PLAN_OPTIONS_INCLUDE</code> can be triggered by <code>plan_exclude</code> / <code>plan_include</code> in Makefile:</p>
<p>e.g.</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">plan_exclude:</span></span><br><span class="line">	terraform plan -out current.plan <span class="variable">$(<span class="built_in">call</span> PLAN_OPTIONS_EXCLUDE,<span class="variable">$(EXCLUDE)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section">plan_include:</span></span><br><span class="line">	terraform plan -out current.plan <span class="variable">$(<span class="built_in">call</span> PLAN_OPTIONS_INCLUDE,<span class="variable">$(INCLUDE)</span>)</span></span><br></pre></td></tr></table></figure>

<h1 id="Gist"><a href="#Gist" class="headerlink" title="Gist"></a>Gist</h1><p>Final gist could be find <span class="exturl" data-url="aHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vZGF2aWRsdTEwMDEvZTgzMjAzODI5OWZmZjk5ZDRhNGIyYzZhNzVkNzFiNzg=" title="https://gist.github.com/davidlu1001/e832038299fff99d4a4b2c6a75d71b78">here<i class="fa fa-external-link"></i></span></p>
<h1 id="Limitations"><a href="#Limitations" class="headerlink" title="Limitations"></a>Limitations</h1><p>Unfortunately, when the target list becomes very long (e.g. 49) You start to see <code>Too many command line arguments. Configuration path expected</code>, so this workaround is not enough…</p>
<p>Anyway Inverse targeting is becoming more and more important / necessary in huge terraform plans with lots of modules managed by different teams, so hope there’s an official solution for that in the new future.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://davidlu1001.github.io/2019/04/28/Move-Terraform-resources-between-remote-states/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="David Lu">
      <meta itemprop="description" content="Technology enthusiast">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Davidlu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/28/Move-Terraform-resources-between-remote-states/" class="post-title-link" itemprop="url">Move Terraform resources between remote states</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-28 23:06:24" itemprop="dateCreated datePublished" datetime="2019-04-28T23:06:24+12:00">2019-04-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SRE/" itemprop="url" rel="index"><span itemprop="name">SRE</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Terraform/" itemprop="url" rel="index"><span itemprop="name">Terraform</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/04/28/Move-Terraform-resources-between-remote-states/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/28/Move-Terraform-resources-between-remote-states/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This document outlines the steps to move existing terraform resources to different remote states.</p>
<p>Reference: <span class="exturl" data-url="aHR0cHM6Ly9tZWRpdW0uY29tL0BseW5ubGluODI3L21vdmluZy10ZXJyYWZvcm0tcmVzb3VyY2VzLXN0YXRlcy1mcm9tLW9uZS1yZW1vdGUtc3RhdGUtdG8tYW5vdGhlci1jNzZmOGI3NmE5OTY=" title="https://medium.com/@lynnlin827/moving-terraform-resources-states-from-one-remote-state-to-another-c76f8b76a996">https://medium.com/@lynnlin827/moving-terraform-resources-states-from-one-remote-state-to-another-c76f8b76a996<i class="fa fa-external-link"></i></span></p>
<h3 id="Steps"><a href="#Steps" class="headerlink" title="Steps"></a>Steps</h3><h4 id="1-Move-Terraform-files-to-the-new-folder"><a href="#1-Move-Terraform-files-to-the-new-folder" class="headerlink" title="1. Move Terraform files to the new folder"></a>1. Move Terraform files to the new folder</h4><h4 id="2-Run-make-plan-to-get-a-list-of-resources-that-would-be-deleted"><a href="#2-Run-make-plan-to-get-a-list-of-resources-that-would-be-deleted" class="headerlink" title="2. Run make plan to get a list of resources that would be deleted"></a>2. Run make plan to get a list of resources that <em>would</em> be deleted</h4><p>sample to generate desired commands used for next step</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">terraform</span> plan | grep <span class="string">&#x27;\s-\s&#x27;</span> | sed -e <span class="string">&#x27;s/\s-\s//g&#x27;</span> | awk <span class="string">&#x27;&#123;print &quot;terraform state mv -state-out=monitoring/.terraform/terraform.tfstate &quot;<span class="variable">$1</span>,<span class="variable">$1</span>&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-Ran-commands-bellow-to-move"><a href="#3-Ran-commands-bellow-to-move" class="headerlink" title="3. Ran commands bellow to move"></a>3. Ran commands bellow to move</h4><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd infrastructure</span><br><span class="line"> </span><br><span class="line">terraform <span class="keyword">state</span> mv -state-out=monitoring/.terraform/terraform.tfstate datadog_monitor.monitor-<span class="number">01</span>-composite datadog_monitor.monitor-<span class="number">01</span>-composite</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="4-Push-remote-state-in-new-folder"><a href="#4-Push-remote-state-in-new-folder" class="headerlink" title="4. Push remote state in new folder"></a>4. Push remote state in new folder</h4><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd monitoring</span><br><span class="line"></span><br><span class="line">terraform <span class="keyword">state</span> push .terraform/terraform.tfstate</span><br></pre></td></tr></table></figure>

<p>As in the company we use <code>Makefile</code> to chain several steps together, so remember to push the remote state before run <code>make plan</code> (otherwise the tfstate will be deleted):</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">clean:</span><br><span class="line">	<span class="built_in">rm</span> <span class="literal">-rf</span> .terraform</span><br><span class="line">	<span class="built_in">rm</span> <span class="operator">-f</span> current.plan</span><br><span class="line">	<span class="built_in">rm</span> <span class="operator">-f</span> *.tf.json</span><br><span class="line"></span><br><span class="line">plan: clean check_remote_modules init get_modules</span><br><span class="line">	terraform plan <span class="literal">-out</span> current.plan <span class="variable">$</span>&#123;PLAN_OPTIONS&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-Check-by-make-plan"><a href="#5-Check-by-make-plan" class="headerlink" title="5. Check by make plan"></a>5. Check by make plan</h4><p>Example of a <code>terraform plan</code> from <code>infrastructure/monitoring</code> folder to confirm that nothing has changed</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">If you ever <span class="built_in">set</span> or change modules or backend configuration <span class="keyword">for</span> Terraform,</span><br><span class="line">rerun this command <span class="keyword">to</span> reinitialize your working directory. If you forget, other</span><br><span class="line">commands will detect it and remind you <span class="keyword">to</span> do so if necessary.</span><br><span class="line">rm -f current.plan</span><br><span class="line">rm -f *.tf.json</span><br><span class="line">Nothing <span class="keyword">to</span> do</span><br><span class="line">terraform get</span><br><span class="line">terraform plan -out current.plan</span><br><span class="line">Refreshing Terraform <span class="keyword">state</span> in-memory prior <span class="keyword">to</span> plan...</span><br><span class="line">The refreshed <span class="keyword">state</span> will be used <span class="keyword">to</span> calculate this plan, but will not be</span><br><span class="line">persisted <span class="keyword">to</span> local or remote <span class="keyword">state</span> storage.</span><br><span class="line"> </span><br><span class="line">datadog_monitor.monitor-<span class="number">01</span>-composite: Refreshing <span class="keyword">state</span>... (ID: <span class="number">8413395</span>)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"> </span><br><span class="line">No changes. Infrastructure is up-to-date.</span><br><span class="line"> </span><br><span class="line">This means that Terraform did not detect <span class="literal">any</span> differences between your</span><br><span class="line">configuration and real physical resources that exist. As a result, <span class="keyword">no</span></span><br><span class="line">actions need <span class="keyword">to</span> be performed.</span><br></pre></td></tr></table></figure>

<p><code>terraform plan</code> from main folder</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">aws_alb_listener.<span class="attr">main:</span> Refreshing state... (<span class="attr">ID:</span> <span class="attr">arn:</span><span class="attr">aws:</span><span class="attr">elasticloadbalancing:</span>us-west<span class="number">-2</span>:...tion<span class="regexp">/22124b66b571c93f/</span><span class="number">1553846</span>d70106854)</span><br><span class="line">aws_alb_listener.<span class="attr">main:</span> Refreshing state... (<span class="attr">ID:</span> <span class="attr">arn:</span><span class="attr">aws:</span><span class="attr">elasticloadbalancing:</span>us-west<span class="number">-2</span>:...tion<span class="regexp">/ce700936e3b458e3/</span><span class="number">4</span>f8982a6592d6312)</span><br><span class="line">aws_alb_listener.<span class="attr">main:</span> Refreshing state... (<span class="attr">ID:</span> <span class="attr">arn:</span><span class="attr">aws:</span><span class="attr">elasticloadbalancing:</span>us-west<span class="number">-2</span>:...tion<span class="regexp">/cb803380f953aafc/</span><span class="number">3</span>c695ba20ad9d237)</span><br><span class="line"> </span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"> </span><br><span class="line">No changes. Infrastructure is up-to-date.</span><br><span class="line"> </span><br><span class="line">This means that Terraform did not detect any differences between your</span><br><span class="line">configuration and real physical resources that exist. As a result, no</span><br><span class="line">actions need to be performed.</span><br></pre></td></tr></table></figure>

<h4 id="6-Recovery-in-case-ruin-the-remote-state"><a href="#6-Recovery-in-case-ruin-the-remote-state" class="headerlink" title="6. Recovery in case ruin the remote state"></a>6. Recovery in case ruin the remote state</h4><p>For Step 4, if ran <code>make plan</code> before pushing the remote state in new folder, the dedicated remote state file will be deleted, and the make plan output will show that the new resources would be created.</p>
<p>So for recovery, there’re two places that can give some hints.</p>
<h5 id="Local-terraform-backup"><a href="#Local-terraform-backup" class="headerlink" title="Local terraform backup"></a>Local terraform backup</h5><p>Terraform usually creates a backup file under <code>.terraform/</code> (after run <code>terraform state mv</code> command in Step 3)</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">davidlu</span> 329622 <span class="selector-tag">May</span>  5 10<span class="selector-pseudo">:46</span> <span class="selector-tag">terraform</span><span class="selector-class">.tfstate</span>.1588632389<span class="selector-class">.backup</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">davidlu</span> 328503 <span class="selector-tag">May</span>  5 10<span class="selector-pseudo">:46</span> <span class="selector-tag">terraform</span><span class="selector-class">.tfstate</span>.1588632399<span class="selector-class">.backup</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">davidlu</span> 327160 <span class="selector-tag">May</span>  5 10<span class="selector-pseudo">:46</span> <span class="selector-tag">terraform</span><span class="selector-class">.tfstate</span>.1588632409<span class="selector-class">.backup</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">davidlu</span> 326185 <span class="selector-tag">May</span>  5 10<span class="selector-pseudo">:47</span> <span class="selector-tag">terraform</span><span class="selector-class">.tfstate</span>.1588632420<span class="selector-class">.backup</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">davidlu</span> 322535 <span class="selector-tag">May</span>  5 10<span class="selector-pseudo">:47</span> <span class="selector-tag">terraform</span><span class="selector-class">.tfstate</span>.1588632429<span class="selector-class">.backup</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">davidlu</span> 319527 <span class="selector-tag">May</span>  5 10<span class="selector-pseudo">:47</span> <span class="selector-tag">terraform</span><span class="selector-class">.tfstate</span>.1588632438<span class="selector-class">.backup</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">davidlu</span> 316520 <span class="selector-tag">May</span>  5 10<span class="selector-pseudo">:47</span> <span class="selector-tag">terraform</span><span class="selector-class">.tfstate</span>.1588632449<span class="selector-class">.backup</span></span><br></pre></td></tr></table></figure>

<h5 id="S3-bucket-recommend"><a href="#S3-bucket-recommend" class="headerlink" title="S3 bucket (recommend)"></a>S3 bucket (recommend)</h5><p>We can still restore an older remote state version from S3</p>
<p><strong><em>Steps</em></strong>:</p>
<ol>
<li><p>Download original older remote state file from S3 (e.g. <code>production-terraform/datastores/production</code>)</p>
</li>
<li><p>Extract the related resources (e.g. blaze)</p>
<ul>
<li>Search the keyword and copy &amp; paste</li>
<li>The above process can be tedious and error-prone: introduce <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RvbW5vbW5vbS9ncm9u" title="https://github.com/tomnomnom/gron">gron<i class="fa fa-external-link"></i></span> here - would be helpful for <strong>double-check</strong> (can make JSON greppable and turn filtered data back into JSON)</li>
</ul>
</li>
</ol>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e.g.</span><br><span class="line"></span><br><span class="line">gron original_older_remote_state.json | <span class="type">grep</span> blaze | <span class="type">gron</span> -u</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Tweak config to match</li>
</ol>
<ul>
<li>Base the previous steps, we’ve got the remote state file in new folder, something like this:</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">&quot;terraform_version&quot;</span>: <span class="string">&quot;0.11.14&quot;</span>,</span><br><span class="line">    <span class="string">&quot;serial&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">&quot;lineage&quot;</span>: <span class="string">&quot;e092833e-c86c-edb2-1c15-c5e04f1923d7&quot;</span>,</span><br><span class="line">    <span class="string">&quot;modules&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;path&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;root&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;outputs&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;resources&quot;</span>: &#123;</span><br><span class="line"></span><br><span class="line">                [...RESOURCES...]</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;depends_on&quot;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Download remote state file for new folder (e.g. <code>production-terraform/datastores/services/blaze</code>)</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;serial&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;lineage&quot;</span>: <span class="string">&quot;e092833e-c86c-edb2-1c15-c5e04f1923d7&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;backend&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;s3&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;config&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;bucket&quot;</span>: <span class="string">&quot;production-terraform&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;datastores/services/blaze&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;region&quot;</span>: <span class="string">&quot;us-west-2&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;hash&quot;</span>: <span class="number">3065110275131057704</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;modules&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;path&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;root&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;outputs&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">&quot;resources&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">&quot;depends_on&quot;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li>Make sure has the same lineage, and higher version of serial (compared with destination in S3)</li>
</ul>
<blockquote>
<p><strong><em>Differing lineage</em></strong>: The “lineage” is a unique ID assigned to a state when it is created. If a lineage is different, then it means the states were created at different times and its very likely you’re modifying a different state. Terraform will not allow this.</p>
<p><strong><em>Higher serial</em></strong>: Every state has a monotonically increasing “serial” number. If the destination state has a higher serial, Terraform will not allow you to write it since it means that changes have occurred since the state you’re attempting to write.</p>
<p>Ref: <span class="exturl" data-url="aHR0cHM6Ly93d3cudGVycmFmb3JtLmlvL2RvY3MvYmFja2VuZHMvc3RhdGUuaHRtbA==" title="https://www.terraform.io/docs/backends/state.html">https://www.terraform.io/docs/backends/state.html<i class="fa fa-external-link"></i></span></p>
</blockquote>
<ul>
<li>Upload new tfstate file to S3</li>
</ul>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">e.g.</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">aws</span> <span class="built_in">s3</span> <span class="meta">cp</span> blaze <span class="built_in">s3</span>:<span class="comment">//production-terraform/datastores/services/blaze</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Run <code>terraform plan</code> in new folder (no changes expected)</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://davidlu1001.github.io/2018/08/20/AWS-Glue-Knowledge-Base/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="David Lu">
      <meta itemprop="description" content="Technology enthusiast">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Davidlu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/20/AWS-Glue-Knowledge-Base/" class="post-title-link" itemprop="url">AWS Glue - Knowledge Base</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-20 23:41:58" itemprop="dateCreated datePublished" datetime="2018-08-20T23:41:58+12:00">2018-08-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AWS/" itemprop="url" rel="index"><span itemprop="name">AWS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SRE/" itemprop="url" rel="index"><span itemprop="name">SRE</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Glue/" itemprop="url" rel="index"><span itemprop="name">Glue</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ElasticSearch/" itemprop="url" rel="index"><span itemprop="name">ElasticSearch</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/08/20/AWS-Glue-Knowledge-Base/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/08/20/AWS-Glue-Knowledge-Base/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Glue-Official-FAQ"><a href="#Glue-Official-FAQ" class="headerlink" title="Glue - Official FAQ"></a>Glue - Official FAQ</h1><p>The official doc for troubleshooting could be found <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2dsdWUvbGF0ZXN0L2RnL3Ryb3VibGVzaG9vdGluZy1nbHVlLmh0bWw=" title="https://docs.aws.amazon.com/glue/latest/dg/troubleshooting-glue.html">here<i class="fa fa-external-link"></i></span></p>
<h1 id="Troubleshooting-Notes-amp-Tips"><a href="#Troubleshooting-Notes-amp-Tips" class="headerlink" title="Troubleshooting - Notes &amp; Tips"></a>Troubleshooting - Notes &amp; Tips</h1><p>Notes and tips for Glue when implementing the ETL process:</p>
<h2 id="Naming-rules-conventions-for-AWS-services"><a href="#Naming-rules-conventions-for-AWS-services" class="headerlink" title="Naming rules / conventions for AWS services"></a>Naming rules / conventions for AWS services</h2><ul>
<li>S3 bucket name can either NOT uppercase nor NOT contain “_” </li>
<li>Dynamo DB table / Name can NOT contain “-“</li>
<li>ES / Name: can NOT contain “-“</li>
</ul>
<h2 id="ACM-SSL-Cert"><a href="#ACM-SSL-Cert" class="headerlink" title="ACM SSL Cert"></a>ACM SSL Cert</h2><p>Using <code>us-east-1</code> region for AWS CloudFront (certificate)</p>
<h2 id="ElasticSearch-Schema"><a href="#ElasticSearch-Schema" class="headerlink" title="ElasticSearch Schema"></a>ElasticSearch Schema</h2><p>Updated the ES mappings in all environments so that field A searches are now case insensitive and will work with spaces in A names</p>
<p>e.g. Fixed the issue for field A so searches are now case insensitive and will work with spaces in A names</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">query</span>=<span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;terms&quot;:&#123;&quot;name&quot;:[&quot;gift vouchers&quot;]&#125;&#125;&#125;&#x27;</span></span><br><span class="line">python sign_request.py -X <span class="builtin-name">GET</span> <span class="variable">$es</span>/A/_search -d <span class="string">&quot;<span class="variable">$query</span>&quot;</span></span><br><span class="line">| jq -r <span class="string">&#x27;.hits.hits&#x27;</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">    <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">    <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;AWSXXXXXXXXXXXXXXXX&quot;</span>,</span><br><span class="line">    <span class="string">&quot;_score&quot;</span>: Y.Z,</span><br><span class="line">    <span class="string">&quot;_source&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Gift Vouchers&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>


<p>e.g. Fixed the issue for field B with spaces not returning quotes:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;normalizer&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;lowercase_normalizer&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;custom&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;char_filter&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;filter&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;lowercase&quot;</span>,</span><br><span class="line">            <span class="string">&quot;asciifolding&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;A&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span>: <span class="number">256</span>,</span><br><span class="line">              <span class="attr">&quot;normalizer&quot;</span>: <span class="string">&quot;lowercase_normalizer&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Publish-Glue-scripts-to-S3"><a href="#Publish-Glue-scripts-to-S3" class="headerlink" title="Publish Glue scripts to S3"></a>Publish Glue scripts to S3</h2><p>AWS S3 wildcards for copying scripts to bucket:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 sync . s3:<span class="regexp">//</span>$(S3_BUCKET)<span class="regexp">/$(FUNCTION_NAME)_Glue/</span> --recursive --exclude <span class="string">&quot;*&quot;</span> --include <span class="string">&quot;glue_*.py&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Glue-Crawler-DependsOn"><a href="#Glue-Crawler-DependsOn" class="headerlink" title="Glue - Crawler - DependsOn"></a>Glue - Crawler - <em>DependsOn</em></h2><p>If not using <code>DependsOn: Connection</code> in Glue Crawler, it won’t create Resource <code>Connection</code> before <code>Crawler</code>.</p>
<p>And the error message is as follows:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">===&gt; JDBC Connection not <span class="attr">registered:</span> (<span class="attr">Service:</span> AWSGlue; Status <span class="attr">Code:</span></span><br><span class="line"><span class="number">400</span>; Error <span class="attr">Code:</span> InvalidInputException; Request <span class="attr">ID:</span></span><br><span class="line"><span class="number">5</span>cd88624<span class="number">-78</span>f3<span class="number">-11e8</span>-bf94<span class="number">-23377</span>d56a892)</span><br></pre></td></tr></table></figure>

<p>Code in <code>AWS CloudFormation</code> template:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># Create a crawler to crawl the flights data</span></span><br><span class="line"><span class="symbol">  CrawlerFlights:</span></span><br><span class="line"><span class="symbol">    Type:</span> AWS::Glue::Crawler</span><br><span class="line"><span class="symbol">    DependsOn:</span> GlueConnectionRDS</span><br></pre></td></tr></table></figure>

<h2 id="ES-Timeout-issue-using-NAT-gateway"><a href="#ES-Timeout-issue-using-NAT-gateway" class="headerlink" title="ES Timeout issue - using NAT gateway"></a>ES Timeout issue - using NAT gateway</h2><h3 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h3><p>ES use Internet Endpoint (not VPC Endpoint)<br>Can’t use <code>VPC endpoint</code> for search services - it must be accessible from <code>AWS AppSync</code><br>So when creating Glue connection, it would connect to DB</p>
<h3 id="AWS-Official-Doc"><a href="#AWS-Official-Doc" class="headerlink" title="AWS Official Doc"></a>AWS Official Doc</h3><blockquote>
<p>All JDBC data stores that are accessed by the job must be available from the VPC subnet.</p>
<p>If your job needs to access both VPC resources and the public internet, the VPC needs to have a Network Address Translation (NAT) gateway inside the VPC.</p>
<p>The network interface is not assigned any public IP addresses. AWS Glue requires internet access (for example, to access AWS services that don’t have VPC endpoints). You can configure a network address translation (NAT) instance inside your VPC, or you can use the Amazon VPC NAT gateway.</p>
</blockquote>
<h3 id="Adding-Glue-Subnet"><a href="#Adding-Glue-Subnet" class="headerlink" title="Adding Glue Subnet"></a>Adding Glue Subnet</h3><p>So a specific Glue subnet with public access is needed.</p>
<h3 id="DB-Security-Group"><a href="#DB-Security-Group" class="headerlink" title="DB Security Group"></a>DB Security Group</h3><p>For the DB need to add <code>self ref SG</code>, otherwise it’ll get ERROR as follows:</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Error: </span>Inbound Rule in Security Group Required</span><br></pre></td></tr></table></figure>

<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2dsdWUvbGF0ZXN0L2RnL2dsdWUtdHJvdWJsZXNob290aW5nLWVycm9ycy5odG1sI2Vycm9yLWluYm91bmQtc2VsZi1yZWZlcmVuY2UtcnVsZQ==" title="https://docs.aws.amazon.com/glue/latest/dg/glue-troubleshooting-errors.html#error-inbound-self-reference-rule">AWS Doc<i class="fa fa-external-link"></i></span>:</p>
<blockquote>
<p>At least one security group must open all ingress ports. To limit traffic, the source security group in your inbound rule can be restricted to the same security group.</p>
</blockquote>
<h3 id="Code-Example-Security-Group"><a href="#Code-Example-Security-Group" class="headerlink" title="Code Example (Security Group)"></a>Code Example (Security Group)</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">ADBSecurityGroup:</span></span><br><span class="line"><span class="symbol">    Type:</span> AWS::EC2::SecurityGroup</span><br><span class="line"><span class="symbol">    Properties:</span></span><br><span class="line"><span class="symbol">      GroupDescription:</span></span><br><span class="line"><span class="symbol">        Fn:</span>:Sub: $&#123;AWS::StackName&#125; A DB Security Group</span><br><span class="line"><span class="symbol">      VpcId:</span></span><br><span class="line"><span class="symbol">        Fn:</span>:ImportValue:</span><br><span class="line"><span class="symbol">          Fn:</span>:Sub: $&#123;Environment&#125;-vpc-id</span><br><span class="line"><span class="symbol">      SecurityGroupIngress:</span></span><br><span class="line">        - CidrIp:</span><br><span class="line"><span class="symbol">            Fn:</span>:ImportValue:</span><br><span class="line"><span class="symbol">              Fn:</span>:Sub: $&#123;Environment&#125;-database-subnets-cidr</span><br><span class="line"><span class="symbol">          FromPort:</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">          ToPort:</span> <span class="number">65535</span></span><br><span class="line"><span class="symbol">          IpProtocol:</span> tcp</span><br><span class="line"><span class="symbol">      Tags:</span></span><br><span class="line">        - Key: Name</span><br><span class="line"><span class="symbol">          Value:</span></span><br><span class="line"><span class="symbol">            Fn:</span>:Sub:</span><br><span class="line">$&#123;AWS::StackName&#125;-glue-A-primary-security-group</span><br><span class="line"><span class="symbol">  ASecurityGroupIngress:</span></span><br><span class="line"><span class="symbol">    Type:</span> AWS::EC2::SecurityGroupIngress</span><br><span class="line"><span class="symbol">    DependsOn:</span> ADBSecurityGroup</span><br><span class="line"><span class="symbol">    Properties:</span></span><br><span class="line"><span class="symbol">      GroupId:</span></span><br><span class="line"><span class="symbol">        Fn:</span>:Sub: $&#123;ADBSecurityGroup.GroupId&#125;</span><br><span class="line"><span class="symbol">      IpProtocol:</span> tcp</span><br><span class="line"><span class="symbol">      FromPort:</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">      ToPort:</span> <span class="number">65535</span></span><br><span class="line"><span class="symbol">      SourceSecurityGroupId:</span></span><br><span class="line"><span class="symbol">        Fn:</span>:Sub: $&#123;ADBSecurityGroup.GroupId&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Code-Example-Glue-Cloudformation-Template"><a href="#Code-Example-Glue-Cloudformation-Template" class="headerlink" title="Code Example (Glue Cloudformation Template)"></a>Code Example (Glue Cloudformation Template)</h1><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Glue Job</span></span><br><span class="line">  <span class="attr">XGlueJob</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">Type</span>: <span class="string">AWS::Glue::Job</span></span><br><span class="line">    <span class="attr">Properties</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">Name</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">Fn</span>:<span class="string">:Sub: $&#123;AWS::StackName&#125;-X-GlueJob</span></span><br><span class="line"><span class="comment">      #LogUri: &quot;wikiData&quot; </span></span><br><span class="line">      <span class="attr">Connections</span>:<span class="string"></span></span><br><span class="line"><span class="comment">        # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-glue-job-connectionslist.html</span></span><br><span class="line">        <span class="attr">Connections</span>:<span class="string"></span></span><br><span class="line">          <span class="meta">-</span> <span class="string">Ref: XGlueConnectionRDS</span></span><br><span class="line">      <span class="attr">Role</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">Ref</span>: <span class="string">GlueJobTriggerRole</span></span><br><span class="line">      <span class="attr">Command</span>:<span class="string"></span></span><br><span class="line"><span class="comment">        # The name of the job command: this must be &quot;glueetl&quot;</span></span><br><span class="line"><span class="comment">        # https://docs.aws.amazon.com/glue/latest/dg/aws-glue-api-jobs-job.html#aws-glue-api-jobs-job-JobCommand</span></span><br><span class="line">        <span class="attr">Name</span>: <span class="string">glueetl</span></span><br><span class="line">        <span class="attr">ScriptLocation</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">Fn</span>:<span class="string">:Sub:</span></span><br><span class="line"><span class="attr">s3</span>:<span class="string">//$&#123;S3Bucket&#125;/productServicesGlue/glue.py</span></span><br><span class="line">      <span class="attr">DefaultArguments</span>:<span class="string"></span></span><br><span class="line">        <span class="meta">&quot;--continuation-option&quot;</span>: <span class="string">&quot;continuation-enabled&quot;</span></span><br><span class="line"><span class="comment">        # use &quot;TempDir&quot; refer to:</span></span><br><span class="line"><span class="comment">        # https://docs.aws.amazon.com/glue/latest/dg/populate-with-cloudformation-templates.html#sample-cfn-template-job-jdbc</span></span><br><span class="line">        <span class="meta">&quot;--TempDir&quot;</span>:<span class="string"></span></span><br><span class="line"><span class="attr">s3</span>:<span class="string">//aws-glue-temporary-&#123;account_id&#125;-$&#123;region&#125;/admin</span></span><br><span class="line">        <span class="meta">&quot;--extra-py-files&quot;</span>: <span class="string"></span></span><br><span class="line">          <span class="attr">Fn</span>:<span class="string">:Sub:</span></span><br><span class="line"><span class="attr">s3</span>:<span class="string">//$&#123;S3Bucket&#125;/productServicesGlue/productServicesGlue.zip</span></span><br><span class="line">        <span class="meta">&quot;--elasticsearch_host&quot;</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">Ref</span>: <span class="string">ElasticSearchHost</span></span><br><span class="line">        <span class="meta">&quot;--db_name&quot;</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">Ref</span>: <span class="string">XGlueDatabaseName</span></span><br><span class="line">        <span class="meta">&quot;--table_name&quot;</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">Fn</span>:<span class="string">:Join:</span></span><br><span class="line">          <span class="meta">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">          <span class="meta">-</span> <span class="string">- Ref: XTablePrefixName</span></span><br><span class="line">            <span class="meta">-</span> <span class="string">Ref: XGlueTableName</span></span><br><span class="line">      <span class="attr">MaxRetries</span>: <span class="string">0</span></span><br><span class="line">      <span class="attr">AllocatedCapacity</span>: <span class="string">2  </span></span><br><span class="line">      <span class="attr">ExecutionProperty</span>:   <span class="string"></span></span><br><span class="line">        <span class="attr">MaxConcurrentRuns</span>: <span class="string">1</span></span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL0FtYXpvblMzL2xhdGVzdC9kZXYvQnVja2V0UmVzdHJpY3Rpb25zLmh0bWw=" title="https://docs.aws.amazon.com/AmazonS3/latest/dev/BucketRestrictions.html">https://docs.aws.amazon.com/AmazonS3/latest/dev/BucketRestrictions.html<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2FtYXpvbmR5bmFtb2RiL2xhdGVzdC9kZXZlbG9wZXJndWlkZS9Ib3dJdFdvcmtzLk5hbWluZ1J1bGVzRGF0YVR5cGVzLmh0bWw=" title="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.NamingRulesDataTypes.html">https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.NamingRulesDataTypes.html<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2NsaS9sYXRlc3QvcmVmZXJlbmNlL3MzL2luZGV4Lmh0bWwjdXNlLW9mLWV4Y2x1ZGUtYW5kLWluY2x1ZGUtZmlsdGVycw==" title="https://docs.aws.amazon.com/cli/latest/reference/s3/index.html#use-of-exclude-and-include-filters">https://docs.aws.amazon.com/cli/latest/reference/s3/index.html#use-of-exclude-and-include-filters<i class="fa fa-external-link"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2dsdWUvbGF0ZXN0L2RnL2dsdWUtdHJvdWJsZXNob290aW5nLWVycm9ycy5odG1sI2Vycm9yLWluYm91bmQtc2VsZi1yZWZlcmVuY2UtcnVsZQ==" title="https://docs.aws.amazon.com/glue/latest/dg/glue-troubleshooting-errors.html#error-inbound-self-reference-rule">https://docs.aws.amazon.com/glue/latest/dg/glue-troubleshooting-errors.html#error-inbound-self-reference-rule<i class="fa fa-external-link"></i></span></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://davidlu1001.github.io/2018/03/08/Clean-puppet-agent-certificates/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="David Lu">
      <meta itemprop="description" content="Technology enthusiast">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Davidlu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/08/Clean-puppet-agent-certificates/" class="post-title-link" itemprop="url">Clean puppet agent certificates</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-03-08 23:42:16" itemprop="dateCreated datePublished" datetime="2018-03-08T23:42:16+13:00">2018-03-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">DevOps</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Puppet/" itemprop="url" rel="index"><span itemprop="name">Puppet</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/03/08/Clean-puppet-agent-certificates/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/03/08/Clean-puppet-agent-certificates/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This document outlines the steps to clean or regenerate puppet agent certificates in a traditional master/client setup.</p>
<p>First thing is to ssh into the agent </p>
<p>Then, delete all <code>*.pem</code> files in <code>/var/lib/puppet/ssl</code> associated to your instance.<br>e.g they should be in the form of <HOSTNAME>.pem</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@<span class="symbol">gateway:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">puppet</span>/<span class="title">ssl</span><span class="comment"># hostname -f</span></span></span><br><span class="line">gateway.ap-southeast-<span class="number">2</span>.aws.ci.xxxxxx.com</span><br><span class="line"></span><br><span class="line">root@<span class="symbol">gateway:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">puppet</span>/<span class="title">ssl</span><span class="comment"># find . -type f | grep &quot;gateway.ap-southeast-2.aws.ci.xxxxxx.com&quot;</span></span></span><br><span class="line">./public_keys/gateway.ap-southeast-<span class="number">2</span>.aws.ci.xxxxxx.com.pem</span><br><span class="line">./private_keys/gateway.ap-southeast-<span class="number">2</span>.aws.ci.xxxxxx.com.pem</span><br><span class="line">./certificate_requests/gateway.ap-southeast-<span class="number">2</span>.aws.ci.xxxxxx.com.pem</span><br><span class="line">./certs/gateway.ap-southeast-<span class="number">2</span>.aws.ci.xxxxxx.com.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># to delete them</span></span><br><span class="line">find . -<span class="keyword">type</span> f | grep <span class="string">&quot;gateway.ap-southeast-2.aws.ci.xxxxxx.com&quot;</span> | xargs rm -rf</span><br></pre></td></tr></table></figure>

<p>Next step is to ssh into the puppet master and do the same</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@puppet-<span class="symbol">master:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">puppet</span>/<span class="title">ssl</span><span class="comment"># find . -type f | grep &quot;gateway&quot;</span></span></span><br><span class="line">./ca/signed/gateway.ap-southeast-<span class="number">2</span>.aws.ci.xxxxxx.com.pem</span><br></pre></td></tr></table></figure>

<p>Ideally there should be only one file hanging in there.</p>
<p>Then back to the agent and try running a –noop puppet run to force a new certificate request. After this, go back to the puppet master and check for any pending cert waiting for approval.</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@puppet-master:/<span class="keyword">var</span>/<span class="keyword">log</span>/puppet# puppet cert <span class="keyword">list</span> | grep <span class="string">&quot;gateway&quot;</span></span><br><span class="line">  <span class="string">&quot;gateway.ap-southeast-2.aws.ci.xxxxxx.com&quot;</span>                    (SHA256) E8:D2:83:89:34:A4:AD:14:EA:83:73:8A:B9:E6:98:D9:6C:4F:47:C6:07:5D:D6:D0:9A:F1:32:C8:33:74:98:D0</span><br><span class="line">Cool! Now you just need to sign the certificate.</span><br><span class="line"></span><br><span class="line">root@puppet-master:/<span class="keyword">var</span>/<span class="keyword">log</span>/puppet# puppet cert sign gateway.<span class="keyword">ap</span>-southeast-2.aws.<span class="keyword">ci</span>.xxxxxx.com</span><br><span class="line">Notice: Signed certificate request <span class="keyword">for</span> gateway.<span class="keyword">ap</span>-southeast-2.aws.<span class="keyword">ci</span>.xxxxxx.com</span><br><span class="line">Notice: Removing <span class="keyword">file</span> Puppet::SSL::CertificateRequest gateway.<span class="keyword">ap</span>-southeast-2.aws.<span class="keyword">ci</span>.xxxxxx.com at &#x27;/<span class="keyword">var</span>/lib/puppet/ssl/<span class="keyword">ca</span>/requests/gateway.<span class="keyword">ap</span>-southeast-2.aws.<span class="keyword">ci</span>.xxxxxx.com.pem&#x27;</span><br></pre></td></tr></table></figure>

<p>Lastly, go back to the agent host and try running a couple of puppet runs.</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">sudo</span> <span class="comment">puppet</span> <span class="comment">agent</span> --<span class="comment">enable</span> <span class="comment">&amp;&amp;</span> <span class="comment">sudo</span> <span class="comment">puppet</span> <span class="comment">agent</span> <span class="literal">-</span><span class="comment">tv</span> --<span class="comment">noop;</span> <span class="comment">sudo</span> <span class="comment">puppet</span> <span class="comment">agent</span> --<span class="comment">disable</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://davidlu1001.github.io/2016/02/20/Linux-find-print0-xargs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="David Lu">
      <meta itemprop="description" content="Technology enthusiast">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Davidlu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/02/20/Linux-find-print0-xargs/" class="post-title-link" itemprop="url">Linux - find print0 & xargs</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-02-20 21:59:59" itemprop="dateCreated datePublished" datetime="2016-02-20T21:59:59+13:00">2016-02-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/02/20/Linux-find-print0-xargs/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/02/20/Linux-find-print0-xargs/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h2><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">root@elastic-data:/mnt/elasticsearch/nodes/<span class="number">0</span>/indices# ls -rthl</span><br><span class="line">...</span><br><span class="line">drwxr-xr-x   <span class="number">4</span> elasticsearch elasticsearch <span class="number">4.0</span>K Apr <span class="number">15</span> <span class="number">14</span>:<span class="number">55</span> _nGsAa--TU-Yt8zAsPWzBw</span><br><span class="line">drwxr-xr-x   <span class="number">5</span> elasticsearch elasticsearch <span class="number">4.0</span>K Apr <span class="number">15</span> <span class="number">14</span>:<span class="number">55</span> -hqCV4oLRG-ttGc8A93BVw</span><br><span class="line">drwxr-xr-x   <span class="number">5</span> elasticsearch elasticsearch <span class="number">4.0</span>K Apr <span class="number">15</span> <span class="number">14</span>:<span class="number">55</span> y4ORbH-YRL65u5JPRWyM3A</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">root@elastic-data:/mnt/elasticsearch/nodes/<span class="number">0</span>/indices# du -sh *</span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;6&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;w&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;U&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;g&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;E&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;Q&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;q&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;I&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;R&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;f&#x27;</span></span><br><span class="line">du: eQWyw: <span class="keyword">No</span> such <span class="keyword">file</span> <span class="keyword">or</span> directory</span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;F&#x27;</span></span><br><span class="line">du: xFiduSIGlLbpGulXyqA: <span class="keyword">No</span> such <span class="keyword">file</span> <span class="keyword">or</span> directory</span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;q&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;C&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;V&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;4&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;o&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;R&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;G&#x27;</span></span><br><span class="line">du: invalid <span class="keyword">option</span> -- <span class="string">&#x27;-&#x27;</span></span><br><span class="line">du: invalid -t argument <span class="string">&#x27;tGc8A93BVw&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-print</span><br><span class="line"></span><br><span class="line">True; print <span class="keyword">the</span> full <span class="built_in">file</span> name <span class="keyword">on</span> <span class="title">the</span> <span class="title">standard</span> <span class="title">output</span>, <span class="title">followed</span> <span class="title">by</span> <span class="title">a</span> <span class="title">newline</span>.   <span class="title">If</span></span><br><span class="line">you are piping <span class="keyword">the</span> output <span class="keyword">of</span> find <span class="keyword">into</span> another program <span class="keyword">and</span> there is  <span class="keyword">the</span>  faintest</span><br><span class="line">possibility  that  <span class="keyword">the</span>  <span class="built_in">files</span> which you are searching <span class="keyword">for</span> might contain <span class="keyword">a</span> newline,</span><br><span class="line"><span class="keyword">then</span> you should seriously consider <span class="keyword">using</span> <span class="keyword">the</span> -print0  option  instead  <span class="keyword">of</span>  -print.</span><br><span class="line">See  <span class="keyword">the</span> UNUSUAL FILENAMES section <span class="keyword">for</span> information about how unusual <span class="keyword">characters</span> <span class="keyword">in</span></span><br><span class="line">filenames are handled.</span><br></pre></td></tr></table></figure>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-print0</span><br><span class="line"></span><br><span class="line">True; print <span class="keyword">the</span> full <span class="built_in">file</span> <span class="built_in">name</span> <span class="keyword">on</span> <span class="keyword">the</span> standard output, followed <span class="keyword">by</span> a null charac‐</span><br><span class="line">ter  (instead  <span class="keyword">of</span> <span class="keyword">the</span> newline <span class="built_in">character</span> <span class="keyword">that</span> -print uses).  This allows <span class="built_in">file</span> names</span><br><span class="line"><span class="keyword">that</span> <span class="keyword">contain</span> newlines <span class="keyword">or</span> other types <span class="keyword">of</span> white <span class="literal">space</span> <span class="keyword">to</span> be correctly interpreted <span class="keyword">by</span></span><br><span class="line">programs  <span class="keyword">that</span>  process <span class="keyword">the</span> find output.  This option corresponds <span class="keyword">to</span> <span class="keyword">the</span> <span class="number">-0</span> option</span><br><span class="line"><span class="keyword">of</span> xargs.</span><br></pre></td></tr></table></figure>

<h2 id="xargs"><a href="#xargs" class="headerlink" title="xargs"></a>xargs</h2><p>Deal with the problem of Argument list too long</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xargs - build and <span class="keyword">execute</span> command <span class="keyword">lines</span> <span class="keyword">from</span> standard <span class="keyword">input</span></span><br><span class="line"></span><br><span class="line"><span class="number">-0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Input</span>  items  <span class="keyword">are</span> <span class="keyword">terminated</span> <span class="keyword">by</span> a <span class="literal">null</span> <span class="built_in">character</span> instead <span class="keyword">of</span> <span class="keyword">by</span> <span class="keyword">whitespace</span>, <span class="keyword">and</span> the</span><br><span class="line">quotes <span class="keyword">and</span> backslash <span class="keyword">are</span> <span class="keyword">not</span> special (every <span class="built_in">character</span> <span class="keyword">is</span> taken  literally).   Dis‐</span><br><span class="line">ables  the  <span class="keyword">end</span>  <span class="keyword">of</span> <span class="keyword">file</span> <span class="keyword">string</span>, which <span class="keyword">is</span> treated <span class="keyword">like</span> <span class="keyword">any</span> other argument.  Useful</span><br><span class="line"><span class="keyword">when</span> <span class="keyword">input</span> items might contain white <span class="keyword">space</span>, quote marks, <span class="keyword">or</span> backslashes.  The  GNU</span><br><span class="line">find -print0 <span class="keyword">option</span> produces <span class="keyword">input</span> suitable <span class="keyword">for</span> this mode.</span><br></pre></td></tr></table></figure>

<h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><p>So for the above errors, using following command check size for the directores:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">find</span> ./ -type d -print<span class="number">0</span> | xargs -<span class="number">0</span> du -s | sort -nk<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>Then we can get the result without errors:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">22790848</span>	./TTW<span class="number">3</span>kNrZQd-BETbHymRqjQ</span><br><span class="line"><span class="attribute">24080308</span>	./ENSiFN<span class="number">9</span>NQe-bv<span class="number">3</span>YH<span class="number">71</span>xG<span class="number">9</span>g</span><br><span class="line"><span class="attribute">33621480</span>	./J<span class="number">50</span>jz<span class="number">5</span>dFS_m<span class="number">6</span>DsiVRBAEMA</span><br><span class="line"><span class="attribute">35486820</span>	./<span class="number">618</span>IZDqDTnee_WoAynubXg</span><br><span class="line"><span class="attribute">1202871344</span>	./</span><br></pre></td></tr></table></figure>

<p>More examples:</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ <span class="keyword">ls</span> -rthl *.<span class="keyword">test</span></span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 20 18:21 file1.<span class="keyword">test</span></span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 20 18:21 file2.<span class="keyword">test</span></span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 20 18:21 <span class="keyword">file</span> 3.<span class="keyword">test</span></span><br><span class="line">-rw-r--r-- 1 root root 0 Feb 20 18:21 fi1e 4.<span class="keyword">test</span></span><br><span class="line"></span><br><span class="line">➜  ~ find . -name <span class="string">&quot;*.test&quot;</span> -<span class="keyword">print</span></span><br><span class="line">./fi1e 3.<span class="keyword">test</span></span><br><span class="line">./<span class="keyword">file</span> 4.<span class="keyword">test</span></span><br><span class="line">./file1.<span class="keyword">test</span></span><br><span class="line">./file2.<span class="keyword">test</span></span><br><span class="line"></span><br><span class="line">➜  ~ find . -name <span class="string">&quot;*.test&quot;</span> -print0</span><br><span class="line">./fi1e 3.<span class="keyword">test</span>./<span class="keyword">file</span> 4.<span class="keyword">test</span>./file1.<span class="keyword">test</span>./file2.<span class="keyword">test</span></span><br><span class="line"></span><br><span class="line">➜  ~ find . -name <span class="string">&quot;*.test&quot;</span> -<span class="keyword">print</span> | xargs <span class="keyword">rm</span></span><br><span class="line"><span class="keyword">rm</span>: cannot remove ‘./fi1e’: <span class="keyword">No</span> such <span class="keyword">file</span> or directory</span><br><span class="line"><span class="keyword">rm</span>: cannot remove ‘3.<span class="keyword">test</span>’: <span class="keyword">No</span> such <span class="keyword">file</span> or directory</span><br><span class="line"><span class="keyword">rm</span>: cannot remove ‘./<span class="keyword">file</span>’: <span class="keyword">No</span> such <span class="keyword">file</span> or directory</span><br><span class="line"><span class="keyword">rm</span>: cannot remove ‘4.<span class="keyword">test</span>’: <span class="keyword">No</span> such <span class="keyword">file</span> or directory</span><br><span class="line"></span><br><span class="line">➜  ~ find . -name <span class="string">&quot;*.test&quot;</span> -print0 | xargs -0 <span class="keyword">rm</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">David Lu</p>
  <div class="site-description" itemprop="description">Technology enthusiast</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RhdmlkbHUxMDAx" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;davidlu1001"><i class="fa fa-fw fa-github"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9kYXZpZGx1MTAwMQ==" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;davidlu1001"><i class="fa fa-fw fa-twitter"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmRhdmlkbHUxMDAxQGdtYWlsLmNvbQ==" title="E-Mail → mailto:davidlu1001@gmail.com"><i class="fa fa-fw fa-envelope"></i></span>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Lu</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="Symbols count total">101k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">1:32</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://davidlu1001.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
